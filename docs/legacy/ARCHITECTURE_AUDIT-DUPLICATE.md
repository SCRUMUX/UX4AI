# Аудит кода на соответствие архитектурным правилам

**Версия:** Фаза 2C — аудит кода (без изменений)  
**Дата создания:** 2024  
**Базовый baseline:** dev-ветка (стабильное состояние)

---

## Инвариант 1: Одна сцена, темы сцену не подменяют

**Правило:** Темы не создают свои сцены и не вызывают `engine.mount()`. Сцена монтируется один раз при инициализации.

### ✅ Соответствие

**Файлы, где проверено:**
- `ui/theme-controller.js` — не вызывает `engine.mount()`
- `ui/themeSwitcher.js` — монтирует сцену один раз в `initThemeSwitcher()`
- `themes/calm.js` — конфигурация сцены, не UI-тема
- `themes/index.js` — реестр сцен, не UI-тем

**Результат:** Правило соблюдается. Сцена монтируется один раз в `ui/themeSwitcher.js` → `mountCalmScene()`, тема не вызывает `engine.mount()`.

### ⚠️ Сомнения

**Нет нарушений.**

---

## Инвариант 2: Единый источник правды по теме и единая точка применения

**Правило:** Текущая тема хранится в `activeThemeId` в `core/state.js`. Смена темы всегда происходит через `applyThemeById()` в `ui/theme-controller.js`. Никакие другие модули не изменяют `.theme-*` классы и не лезут напрямую в `theme-colors`.

### ❌ Нарушения

#### 1. Прямое чтение `localStorage.getItem('colorTheme')` в `core/engine.js`

**Файл:** `core/engine.js`  
**Строки:** 43, 165

**Проблема:**
```javascript
// Строка 43
const savedTheme = typeof localStorage !== 'undefined' ? localStorage.getItem('colorTheme') : 'dark';
// ...
sceneBg = savedTheme === 'light' ? '#FFFFFF' : '#0B0F14';

// Строка 165
const currentTheme = typeof document !== 'undefined' && document.body.classList.contains('theme-light') ? 'light' : 'dark';
const sceneBg = getComputedStyle(document.documentElement).getPropertyValue('--scene-bg').trim() || (currentTheme === 'light' ? '#FFFFFF' : '#0B0F14');
```

**Почему подозрительно:** `core/engine.js` читает тему напрямую из `localStorage` и проверяет классы `.theme-light` для fallback-значений. Это создаёт зависимость от формата хранения темы и может привести к рассинхронизации, если формат изменится.

**Рекомендация:** Использовать `getCurrentThemeId()` из `ui/theme-controller.js` или читать только из CSS-переменных без fallback к `localStorage`.

#### 2. Отсутствие импорта `emit` в `ui/theme-controller.js`

**Файл:** `ui/theme-controller.js`  
**Строка:** 145

**Проблема:**
```javascript
// Строка 8: импортируется только set, get
import { set, get } from '../core/state.js';

// Строка 145: используется emit, но не импортирован
emit('themeChanged', { themeId, themeConfig });
```

**Почему подозрительно:** Это приведёт к runtime error `ReferenceError: emit is not defined` при вызове `applyThemeById()`.

**Статус:** ❌ **Критическая ошибка** — код не будет работать.

### ⚠️ Сомнения

#### 1. Прямое чтение классов для определения темы в fallback-значениях

**Файлы:** `core/hud-manager.js` (строки 96-97, 468-469, 477-478)

**Проблема:** В fallback-значениях используется прямое чтение CSS-переменных с fallback к hex-значениям. Это допустимо, но лучше использовать `getCurrentThemeId()` для определения темы.

**Статус:** ⚠️ **Минимальное нарушение** — используется только для fallback в inline-стилях.

---

## Инвариант 3: Тур и демо не меняют тему и не монтируют сцену

**Правило:** Модули тура и демо не вызывают `applyThemeById()`, `engine.mount()` или аналогичные функции.

### ✅ Соответствие

**Файлы, где проверено:**
- `index.html` (логика тура) — не вызывает `applyThemeById()`, `toggleTheme()`, `engine.mount()`
- `core/hud-manager.js` (кнопка "Демо") — не вызывает функции смены темы или монтирования сцены

**Результат:** Правило соблюдается. Тур только управляет классами `tour-active`, демо открывает HUD без изменения темы.

### ⚠️ Сомнения

#### 1. Управление видимостью кнопки темы в логике тура

**Файл:** `index.html`  
**Строки:** 2650-2657, 2727-2734, 3477-3486

**Проблема:** В логике тура есть код, который управляет видимостью кнопки темы (`theme-toggle-btn`):
```javascript
// CRITICAL: Always ensure theme-toggle-btn is visible (never hide it)
const themeBtn = document.getElementById('theme-toggle-btn');
if (themeBtn) {
  themeBtn.style.display = 'inline-flex';
  themeBtn.style.visibility = 'visible';
  themeBtn.style.opacity = '1';
  themeBtn.style.pointerEvents = 'auto';
}
```

**Почему подозрительно:** Тур не должен управлять UI-элементами, не связанными с туром. Это создаёт связь между туром и системой тем, что нарушает разделение ответственности.

**Статус:** ⚠️ **Нарушение разделения ответственности** — тур не должен управлять кнопкой темы.

---

## Инвариант 4: UI не знает деталей движка

**Правило:** UI-код не создаёт и не монтирует engine напрямую. Взаимодействие идёт через фасады.

### ✅ Соответствие

**Файлы, где проверено:**
- `core/hud-manager.js` — не вызывает `createEngine()` или `engine.mount()`
- `ui/theme-controller.js` — получает ссылку на engine через `setEngine()`, не создаёт его

**Результат:** Правило соблюдается. UI получает ссылку на engine через параметры функций.

### ⚠️ Сомнения

**Нет нарушений.**

---

## Инвариант 5: Цвета только из токенов/тем, без "жёстких" hex в боевом коде

**Правило:** UI-цвета берутся только из `styles/tokens.css` и/или конфигов темы. Цвета для 3D-сцены берутся только из `core/theme-colors.js`. В боевом коде не допускается ручное использование `#xxxxxx`, `rgb(...)`, `new Color('red')`.

### ❌ Нарушения

#### 1. Прямые hex-значения в `index.html` (inline-стили)

**Файл:** `index.html`  
**Строки:** 10-23, 61-62, 269, 275, 277, 283, 286, 299, 355, 399-401, 424-425, 455, 472, 481, 606, 614, 620, 638, 671-678, 713, 743, 746-747, 771-772, 777, 781, 797

**Проблема:** Множество прямых hex/rgb значений в inline-стилях:
- `--critical-bg: #0B0F14;` (строка 10)
- `--critical-text: #E6EEF8;` (строка 11)
- `content="#0B0F14"` (строки 61-62)
- `color: #CFE8FF !important;` (строка 455)
- `background: rgba(91,156,255,0.08);` (строка 638)
- И многие другие

**Почему подозрительно:** Эти значения должны быть в `styles/tokens.css` или использовать CSS-переменные. Исключение — критические inline-стили для предотвращения FOUC, но даже они должны использовать CSS-переменные с fallback.

**Статус:** ❌ **Нарушение** — прямые hex/rgb значения в боевом коде.

#### 2. Прямые hex-значения в `core/engine.js` (fallback)

**Файл:** `core/engine.js`  
**Строки:** 47, 165, 228-230, 377-379

**Проблема:**
```javascript
// Строка 47
sceneBg = savedTheme === 'light' ? '#FFFFFF' : '#0B0F14';

// Строка 165
const sceneBg = getComputedStyle(document.documentElement).getPropertyValue('--scene-bg').trim() || (currentTheme === 'light' ? '#FFFFFF' : '#0B0F14');

// Строки 228-230, 377-379
const textMuted = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#9AA6B2';
const bgOverlay = getComputedStyle(document.documentElement).getPropertyValue('--Color/Dark/Surface/Overlay').trim() || 'rgba(0,0,0,0.5)';
const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#243041';
```

**Почему подозрительно:** Fallback-значения используют прямые hex/rgb. Лучше использовать значения из `core/theme-colors.js` или убрать fallback, если CSS-переменные всегда доступны.

**Статус:** ⚠️ **Нарушение** — fallback-значения должны браться из токенов.

#### 3. Прямые hex-значения в `core/hud-manager.js` (fallback)

**Файл:** `core/hud-manager.js`  
**Строки:** 96-97, 105, 107, 468-469, 477-478

**Проблема:**
```javascript
// Строки 96-97
tabLink.style.borderBottomColor = accentHover || 'rgba(91,156,255,0.8)';
tabLink.style.color = accentColor || '#5B9CFF';

// Строки 105, 107
const borderSubtle = getComputedStyle(document.documentElement).getPropertyValue('--Color/Dark/Border/Subtle').trim() || 'rgba(154,166,178,0.3)';
tabLink.style.color = mutedColor || '#9AA6B2';

// Строки 468-469, 477-478 (аналогично)
```

**Почему подозрительно:** Fallback-значения используют прямые hex/rgb. Лучше использовать значения из `core/theme-colors.js` или убрать fallback.

**Статус:** ⚠️ **Нарушение** — fallback-значения должны браться из токенов.

### ⚠️ Сомнения

#### 1. Использование `rgba()` в динамических стилях

**Файлы:** `core/engine.js`, `core/hud-manager.js`

**Проблема:** В некоторых местах используются `rgba()` для динамических стилей (например, в grid debug). Это может быть допустимо, если значения вычисляются динамически, но лучше использовать CSS-переменные.

**Статус:** ⚠️ **Минимальное нарушение** — допустимо для динамических вычислений, но лучше использовать токены.

---

## Лишние связи между подсистемами

### 1. Тур управляет видимостью кнопки темы

**Файл:** `index.html`  
**Строки:** 2650-2657, 2727-2734, 3477-3486

**Проблема:** Логика тура содержит код для управления видимостью кнопки темы (`theme-toggle-btn`). Это создаёт ненужную связь между туром и системой тем.

**Почему проблема:** Тур не должен знать о существовании кнопки темы. Это нарушает разделение ответственности.

**Рекомендация:** Вынести управление видимостью кнопки темы в отдельный модуль или в `core/hud-manager.js`.

### 2. Engine читает тему напрямую из localStorage

**Файл:** `core/engine.js`  
**Строки:** 43, 165

**Проблема:** `core/engine.js` читает тему напрямую из `localStorage.getItem('colorTheme')` для fallback-значений. Это создаёт зависимость от формата хранения темы.

**Почему проблема:** Engine не должен знать, как хранится тема. Это создаёт связь между engine и системой тем.

**Рекомендация:** Использовать `getCurrentThemeId()` из `ui/theme-controller.js` или читать только из CSS-переменных.

### 3. Множественные MutationObserver для защиты кнопок

**Файлы:** `index.html`, `core/hud-manager.js`

**Проблема:**
- В `index.html` (строка 2788) есть MutationObserver для защиты `tour-restart-btn`
- В `core/hud-manager.js` (строка 1152) есть MutationObserver для защиты `theme-toggle-btn`
- В `index.html` (строки 4145, 4149, 4163) есть ещё несколько MutationObserver для grid overlay

**Почему проблема:** Множественные MutationObserver могут конфликтовать друг с другом и создавать избыточную нагрузку. Кроме того, они создают неявные связи между модулями.

**Рекомендация:** Унифицировать управление видимостью кнопок в одном месте или использовать более простой механизм (например, CSS для скрытия/показа).

---

## Устаревшие файлы, кандидаты на удаление

### 1. `themes/theme-variables.css`

**Статус:** ⚠️ **Подозрительный**

**Проблема:** Файл содержит старые CSS-переменные (`--bg-primary`, `--text-primary` и т.д.), которые могут дублировать функциональность `styles/tokens.css`.

**Проверка использования:**
- ❌ Не импортируется в `index.html`
- ❌ Не используется в `styles/main.css`
- ❌ Не используется в других файлах

**Рекомендация:** Удалить, если не используется. Если используется — проверить, где именно, и мигрировать на `styles/tokens.css`.

### 2. `themes/simple-themes.css`

**Статус:** ⚠️ **Подозрительный**

**Проблема:** Файл содержит определения для light и neon тем, которые могут не использоваться в текущей реализации.

**Проверка использования:**
- ❌ Не импортируется в `index.html`
- ❌ Не используется в `styles/main.css`
- ❌ Не используется в других файлах

**Рекомендация:** Удалить, если не используется. Если используется — проверить, где именно, и мигрировать на `styles/tokens.css`.

### 3. Упоминания Matrix-сцены

**Файлы:** `themes/index.js`

**Проблема:** В `themes/index.js` есть защита от загрузки 'matrix' темы:
```javascript
if (id === 'matrix') {
  console.warn('[Scenes] Matrix scene requested but has been removed, using calm instead');
  return SCENES.calm;
}
```

**Статус:** ⚠️ **Legacy код** — можно оставить для обратной совместимости, но лучше удалить, если Matrix точно не используется.

**Рекомендация:** Удалить защиту, если Matrix точно не используется.

---

## Локальные патчи, которые нужно наблюдать

### 1. Монолитный `index.html`

**Проблема:** `index.html` содержит большой объём inline JavaScript (логика тура, bootstrap, создание кнопок). Это создаёт сложность в поддержке и тестировании.

**Статус:** ⚠️ **Технический долг**

**Рекомендация:** Вынести логику тура в отдельный модуль (`ui/tour-manager.js`), bootstrap — в отдельный файл (`core/bootstrap.js`).

### 2. Дублирование логики создания кнопок

**Проблема:**
- Кнопка темы создаётся в `core/hud-manager.js`
- Кнопка tour-restart создаётся в `index.html` (bootstrap)

**Статус:** ⚠️ **Дублирование**

**Рекомендация:** Унифицировать создание кнопок header в одном месте (например, в `ui/header-buttons.js`).

### 3. Версионирование модулей через query params

**Проблема:** Многие импорты имеют `?v=XX` (например, `./core/engine.js?v=37`). Это используется для cache busting, но создаёт сложность в поддержке.

**Статус:** ⚠️ **Технический долг**

**Рекомендация:** Рассмотреть автоматизацию версионирования через build-процесс.

### 4. Прямое чтение классов для определения темы

**Проблема:** В нескольких местах код читает классы `.theme-light` / `.theme-dark` напрямую для определения темы, вместо использования `getCurrentThemeId()`.

**Файлы:** `core/engine.js` (строка 165), `core/hud-manager.js` (fallback-значения)

**Статус:** ⚠️ **Нарушение инварианта 2**

**Рекомендация:** Использовать `getCurrentThemeId()` из `ui/theme-controller.js` везде, где нужно определить текущую тему.

---

## Итоговая сводка

### Критические нарушения

1. ❌ **Отсутствие импорта `emit` в `ui/theme-controller.js`** — код не будет работать
2. ❌ **Прямые hex/rgb значения в `index.html`** — нарушение инварианта 5
3. ⚠️ **Прямые hex/rgb значения в fallback-значениях** — нарушение инварианта 5

### Нарушения разделения ответственности

1. ⚠️ **Тур управляет видимостью кнопки темы** — нарушение инварианта 3
2. ⚠️ **Engine читает тему напрямую из localStorage** — нарушение инварианта 2

### Технический долг

1. ⚠️ **Монолитный `index.html`** — требует рефакторинга
2. ⚠️ **Дублирование логики создания кнопок** — требует унификации
3. ⚠️ **Множественные MutationObserver** — требуют оптимизации
4. ⚠️ **Устаревшие файлы** (`theme-variables.css`, `simple-themes.css`) — требуют аудита и удаления

### Соответствие инвариантам

- ✅ **Инвариант 1:** Соблюдается
- ⚠️ **Инвариант 2:** Нарушения в fallback-значениях и отсутствие импорта `emit`
- ⚠️ **Инвариант 3:** Нарушение разделения ответственности (тур управляет кнопкой темы)
- ✅ **Инвариант 4:** Соблюдается
- ❌ **Инвариант 5:** Множественные нарушения (прямые hex/rgb значения)

---

**Документ создан:** Фаза 2C (аудит кода)  
**Следующий шаг:** Фаза 2D — исправление выявленных нарушений

