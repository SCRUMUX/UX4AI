<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<!-- Критический CSS - предотвращает белый экран при загрузке -->
<style>
  /* Базовые стили для мгновенного применения - предотвращают FOUC */
  /* PHASE C2: Critical colors now use tokens with fallback for FOUC prevention */
  /* Default dark theme colors - will be overridden by theme-light class */
  :root {
    /* PHASE C2: Use tokens from styles/tokens.css with hex fallback for FOUC prevention */
    /* DARK THEME (default) - light text on dark background */
    --critical-bg: var(--bg, #0D1117);
    --critical-text: var(--text, #F0F6FC);
    --critical-header-bg: var(--Color/Dark/Surface/Ghost, rgba(18, 23, 34, 0.15));
    /* Use semantic tokens from styles/tokens.css */
    /* DARK THEME: light text colors as fallback */
    --critical-logo-name: var(--Header/Logo/Name, #F0F6FC);
    --critical-logo-tagline: var(--Header/Logo/Tagline, #A5B4C6);
    --critical-btn: var(--Header/Button/Text, #A5B4C6);
  }
  :root.theme-light {
    /* PHASE C2: Use tokens from styles/tokens.css with hex fallback for FOUC prevention */
    --critical-bg: var(--bg, #FFFFFF);
    --critical-text: var(--text, #0B0F14);
    --critical-header-bg: var(--Color/Light/Surface/3, rgba(247, 248, 250, 0.95));
    /* Use semantic tokens from styles/tokens.css */
    --critical-logo-name: var(--Header/Logo/Name, #0B0F14);
    --critical-logo-tagline: var(--Header/Logo/Tagline, #6B7280);
    --critical-btn: var(--Header/Button/Text, #6B7280);
  }
  html {
    background: var(--critical-bg) !important;
    color: var(--critical-text) !important;
    margin: 0;
    padding: 0;
    height: 100%;
    overflow-x: hidden;
  }
  body {
    background: transparent !important;
    color: var(--critical-text) !important;
    margin: 0;
    padding: 0;
  }
  /* Хедер - адаптивный к теме */
  header#site-header {
    background: var(--critical-header-bg) !important;
    color: var(--critical-text) !important;
  }
  .header-logo .name {
    color: var(--critical-logo-name) !important;
  }
  .header-logo .tagline {
    color: var(--critical-logo-tagline) !important;
  }
  .header-btn {
    color: var(--critical-btn) !important;
    background: transparent !important;
  }
</style>
<meta content="width=device-width, initial-scale=1, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" name="viewport"/>
<!-- iOS Safari: темная status bar -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<!-- Android Chrome: theme color -->
<!-- PHASE C2: Initial value uses token fallback, will be updated dynamically via JavaScript based on current theme -->
<!-- Theme color will be updated dynamically via JavaScript based on current theme -->
<meta name="theme-color" content="#0B0F14" id="meta-theme-color"/>
<meta name="msapplication-navbutton-color" content="#0B0F14" id="meta-navbutton-color"/>
<title>Владимир Костял — UX4AI: UX-архитектура и интерфейсы для AI</title>
<meta name="description" content="Владимир Костял — проектирую UX-архитектуру и интерфейсы для AI‑сервисов. UX4AI: паттерны, подходы и решения для взаимодействия с ИИ."/>
<meta name="keywords" content="UX, AI, UX архитектура, интерфейсы, проектирование, взаимодействие с ИИ, UX4AI"/>
<link rel="canonical" href="https://ux4ai.pro/"/>

<!-- Open Graph -->
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://ux4ai.pro/"/>
<meta property="og:site_name" content="Владимир Костял — UX4AI"/>
<meta property="og:title" content="Владимир Костял — UX4AI: UX-архитектура и интерфейсы для AI"/>
<meta property="og:description" content="Проектирую UX‑архитектуру и интерфейсы для AI‑сервисов. Паттерны, подходы и решения для взаимодействия с ИИ."/>
<!-- Open Graph images (multiple formats) -->
<meta property="og:image" content="https://ux4ai.pro/preview.webp?v=3"/>
<meta property="og:image:type" content="image/webp"/>
<meta property="og:image:width" content="1200"/>
<meta property="og:image:height" content="630"/>
<meta property="og:image" content="https://ux4ai.pro/preview.png?v=3"/>
<meta property="og:image:type" content="image/png"/>
<meta property="og:image:width" content="1200"/>
<meta property="og:image:height" content="630"/>
<meta property="og:image" content="https://ux4ai.pro/preview.jpg?v=3"/>
<meta property="og:image:type" content="image/jpeg"/>
<meta property="og:image:width" content="1200"/>
<meta property="og:image:height" content="630"/>

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Владимир Костял — UX4AI: UX-архитектура и интерфейсы для AI"/>
<meta name="twitter:description" content="Проектирую UX‑архитектуру и интерфейсы для AI‑сервисов. Паттерны, подходы и решения для взаимодействия с ИИ."/>
<meta name="twitter:image" content="https://ux4ai.pro/preview.webp?v=3"/>
<meta name="twitter:image:alt" content="UX4AI — UX-архитектура и интерфейсы для AI"/>

<!-- Verification (replace content values with real codes) -->
<meta name="google-site-verification" content="REPLACE_WITH_GOOGLE_CODE"/>
<meta name="yandex-verification" content="REPLACE_WITH_YANDEX_CODE"/>

<!-- Schema.org Person and WebSite markup -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Владимир Костял",
  "url": "https://ux4ai.pro/",
  "jobTitle": "UX-архитектор",
  "description": "Проектирую UX-архитектуру и интерфейсы для AI-сервисов. Паттерны, подходы и решения для взаимодействия с ИИ.",
  "worksFor": {
    "@type": "Organization",
    "name": "UX4AI"
  },
  "knowsAbout": ["UX Design", "AI", "User Interface Design", "UX Architecture", "AI Products"],
  "sameAs": [
    "https://t.me/scrumux"
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "UX4AI — UX-архитектура и интерфейсы для AI",
  "url": "https://ux4ai.pro/",
  "description": "Проектирование UX-архитектуры и интерфейсов для AI-сервисов. Паттерны, подходы и решения для взаимодействия с ИИ.",
  "author": {
    "@type": "Person",
    "name": "Владимир Костял"
  },
  "inLanguage": "ru-RU"
}
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105120842', 'ym');

    ym(105120842, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105120842" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<!-- Favicons -->
<link rel="icon" type="image/png" sizes="32x32" href="./favicon.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="./favicon.png"/>
<link rel="apple-touch-icon" sizes="180x180" href="./android-chrome-192x192.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="./android-chrome-192x192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="./android-chrome-512x512.png"/>
<link rel="stylesheet" href="./styles/tokens.css?v=43"/>
<link rel="stylesheet" href="./styles/main.css?v=43"/>
<style>
    /* Scroll world: make body tall so camera flies segment-by-segment */
html {
  margin: 0;
  padding: 0;
  background: var(--bg);
  height: 100%;
  overflow-x: hidden;
  /* Establish consistent typography across the site: the base body text
     corresponds to Text/Body/Base (16px/24px) from the design system. */
  font-size: 16px;
  line-height: 1.5;
  font-weight: 400;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
}
body {
  margin: 0;
  padding: 0;
  background: transparent;
  color: var(--text);
}
/* While orbit is active on mobile, block browser gestures (pan/zoom) */
.orbit-active, .orbit-active body, .orbit-active #three-container { touch-action: none; }
/* Mobile performance optimizations */
@media (max-width: 767px) {
  /* Предотвращение проблем с масштабированием при перезагрузке */
  html {
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  
  body {
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    text-size-adjust: 100%;
    /* Убрал transform: scale - он ломает скролл */
    width: 100% !important;
    max-width: 100vw !important;
    /* Разрешить скролл в обычном режиме */
    overflow-x: hidden !important;
    /* Убрал !important из overflow-y - navigation.js управляет скроллом */
    overflow-y: auto;
    position: relative !important;
    /* Убрал touch-action: pan-y - он конфликтует с navigation.js */
    /* Скролл управляется через navigation.js */
  }
  
  /* Disable tap highlight for better performance */
  * {
    -webkit-tap-highlight-color: transparent;
  }
  /* Optimize touch interactions for buttons and interactive elements */
  button, a, .btn, [role="button"], [tabindex], .tour-segment, .thermometer-segment {
    touch-action: manipulation;
    -webkit-touch-callout: none;
    user-select: none;
    -webkit-user-select: none;
    /* Remove transitions on mobile for instant feedback */
    transition: none !important;
    /* Предотвращение залипаний - оптимизация отклика */
    -webkit-tap-highlight-color: var(--Color/State/Hover/Background, rgba(91, 156, 255, 0.1));
    /* Улучшение производительности */
    will-change: auto;
    transform: translateZ(0); /* GPU acceleration */
  }
  /* Remove transitions for tour buttons on mobile for instant response */
  #tour-overlay .tour-actions .btn {
    transition: none !important;
  }
  /* Disable hover effects on mobile - they can interfere with touch */
  #tour-overlay .tour-actions .btn:hover {
    background: var(--Color/State/Hover/Surface) !important;
    color: var(--tour-text-muted) !important;
    border-color: var(--border) !important;
  }
  #tour-overlay .tour-actions .btn-primary:hover {
    background: var(--Color/State/Active/Background) !important;
  }
  /* Prevent text selection on interactive elements */
  .tour-card, .hud-big-panel, .hud-small-panel {
    -webkit-touch-callout: none;
  }
  /* Optimize will-change usage - only for elements that actually animate */
  .grid-line {
    will-change: auto; /* Remove will-change on mobile for better performance */
  }
}
    /* Height is set dynamically based on segments; keep minimal here */
    #three-container { 
      position:fixed; 
      inset:0; 
      overflow:hidden; 
      background: transparent;
      z-index: 1;
    }
    #labels {
      position: fixed; 
      inset: 0; 
      pointer-events: none;
      background: transparent;
      z-index: 900;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
    }
    .label {
      position:absolute; transform:translate(-50%,-50%);
      padding: 4px 10px;
      pointer-events: auto;
      font-size: 14px;
      letter-spacing: 0.2px;
      font-weight: 400;
      color: var(--HUD/Text/Base);
      background: var(--HUD/Panel/Bg);
      border: 1px solid var(--HUD/Panel/Border);
      border-radius: 10px;
      box-shadow: 0 0 0 1px var(--HUD/Panel/Border) inset, 0 2px 10px var(--Color/Effect/Shadow/Soft);
      white-space: nowrap;
      opacity: 0.96;
    }

    .label:hover {
      background: var(--Color/State/Hover/Background);
      border-color: var(--Color/Accent/Primary);
      color: var(--HUD/Text/Base);
      cursor: pointer;
    }
    /* HUD chips (layer hints) preserved for orientation */
    .hud {
      position: fixed; left: 12px; top: 12px; right: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      /* PHASE C4: Use token directly instead of legacy variable */
      background: var(--Color/Dark/Background/Secondary); border:1px solid var(--border); border-radius:12px; padding:8px 10px; backdrop-filter: blur(6px);
      z-index:10; font-size:12px;
    }
    /* PHASE C4: Use token directly instead of legacy variable */
    .chip { padding:4px 8px; border:1px solid var(--Color/Dark/Border/Default); border-radius:10px; background:var(--Color/Dark/Background/Tertiary); opacity:0.96; }
    .spacer{flex:1}
    .hint {opacity:0.7}

    /* Overlay backdrop for node details. This layer darkens the background when a
       node is selected and enables clicks outside of the panels to close the
       overlay. */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--Color/Dark/Surface/Overlay, rgba(0, 0, 0, 0.45));
      pointer-events: none; /* Always none - don't block clicks */
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 900;
    }
    /* In HUD we используем #hud-backdrop для затемнения, оставляем #overlay прозрачным для кликов */
    .hud-active #overlay { 
      background: transparent !important; 
      pointer-events: none !important; /* Ensure overlay never blocks clicks in HUD mode */
    }
    /* HUD backdrop (similar to tour backdrop) - shows when HUD is active */
    #hud-backdrop {
      position: fixed;
      inset: 0;
      background: var(--hud-backdrop);
      backdrop-filter: blur(2px) saturate(120%);
      z-index: 940;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    #hud-backdrop.hidden {
      display: none !important;
    }
    /* Hide overlay on mobile when not active */
    @media (max-width: 479px) {
      #overlay:not(.active) {
        display: none !important;
      }
      body {
        background: transparent !important;
      }
    }
    #overlay.active {
      pointer-events: none; /* Changed from auto to none - overlay should not block clicks */
      opacity: 1;
    }
    /* HUD backdrop should NOT block clicks - it's just visual */
    #hud-backdrop {
      pointer-events: none !important;
    }
    /* Hide unused legacy panels by default */
    #object-icon, #big-panel, #small-panel {
      display: none;
    }
    /* Detached HUD elements for the clicked node */
    #hud-object-icon {
      position: fixed;
      top: 200px;
      left: 450px;
      right: auto;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: var(--accent); /* will be overridden with the node's colour via JS */
      box-shadow: 0 0 20px rgba(91, 156, 255, 0.5);
      border: 3px solid var(--border);
      display: none;
      z-index: 1000;
    }
    #hud-big-panel {
      position: fixed;
      top: 200px;
      right: 450px;
      left: auto;
      width: 580px;
      max-height: calc(100vh - 250px) !important;  /* limit height to enable scroll */
      height: auto !important;
      overflow-y: auto !important;                /* enable scroll */
      overflow-x: hidden !important;            /* avoid nested horizontal scroll */
      overscroll-behavior: contain !important;  /* prevent scroll chaining */
      background: var(--hud-panel-bg);
      backdrop-filter: blur(2px) saturate(140%);
      border: 1px solid var(--border);
      border-top: none; /* Remove top border */
      border-radius: 0; /* Square corners to match tour style */
      padding: 20px;
      color: var(--hud-text);
      line-height: 1.5;
      white-space: pre-line;
      box-sizing: border-box;        /* keep padding inside bounds */
      overflow-wrap: anywhere;       /* wrap long tokens */
      word-break: break-word;        /* break long words */
      font-weight: 200;
      display: none;
      z-index: 1000;
    }
    /* PHASE C3.3: Mobile styles moved to main.css */
    /* Ensure all text in big panel has consistent weight, except headings */
    #hud-big-panel * {
      font-weight: 200;
    }
    /* Override for headings */
    #hud-big-panel h1,
    #hud-big-panel h2,
    #hud-big-panel h3,
    #hud-big-panel h4,
    #hud-big-panel h5,
    #hud-big-panel h6 {
      font-weight: 600 !important;
    }
    /* Headings in big panel main text use tour style */
    #hud-big-panel h1,
    #hud-big-panel h2,
    #hud-big-panel h3,
    #hud-big-panel h4,
    #hud-big-panel h5,
    #hud-big-panel h6,
    .hud-active #hud-big-panel h1,
    .hud-active #hud-big-panel h2,
    .hud-active #hud-big-panel h3,
    .hud-active #hud-big-panel h4,
    .hud-active #hud-big-panel h5,
    .hud-active #hud-big-panel h6 {
      font: 600 20px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
    }
    /* Main heading (h2) - 10px margin bottom to paragraph */
    #hud-big-panel h2,
    .hud-active #hud-big-panel h2,
    #hud-container #hud-big-panel h2,
    .hud-active #hud-container #hud-big-panel h2 {
      margin: 0 0 10px 0 !important;
    }
    /* Subheadings (h3, h4) - smaller than main heading, no margin */
    #hud-big-panel h3,
    .hud-active #hud-big-panel h3,
    #hud-container #hud-big-panel h3,
    .hud-active #hud-container #hud-big-panel h3 {
      font: 600 18px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
    }
    #hud-big-panel h4,
    .hud-active #hud-big-panel h4,
    #hud-container #hud-big-panel h4,
    .hud-active #hud-container #hud-big-panel h4 {
      font: 600 16px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
    }
    /* Paragraph spacing: 20px between paragraphs */
    #hud-big-panel p,
    .hud-active #hud-big-panel p,
    #hud-container #hud-big-panel p,
    .hud-active #hud-container #hud-big-panel p {
      margin: 0 0 20px 0;
      line-height: 1.5;
    }
    #hud-big-panel p:last-child,
    .hud-active #hud-big-panel p:last-child,
    #hud-container #hud-big-panel p:last-child,
    .hud-active #hud-container #hud-big-panel p:last-child {
      margin-bottom: 0;  /* Убрать отступ у последнего абзаца */
    }
    /* Remove spacing after subheadings - no margin for first paragraph after h3/h4 */
    #hud-big-panel h3 + p,
    #hud-big-panel h4 + p,
    .hud-active #hud-big-panel h3 + p,
    .hud-active #hud-big-panel h4 + p,
    #hud-container #hud-big-panel h3 + p,
    #hud-container #hud-big-panel h4 + p,
    .hud-active #hud-container #hud-big-panel h3 + p,
    .hud-active #hud-container #hud-big-panel h4 + p {
      margin-top: 0;  /* Убрать отступ у первого абзаца после подзаголовка */
    }
    /* Hide scrollbar but keep scrolling */
    #hud-big-panel {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    #hud-big-panel::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    #hud-small-panel {
      position: fixed;
      top: 200px;
      left: 450px;
      right: auto;
      width: 250px;
      display: none;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      background: none;
      border: none;
      z-index: 1000;
    }
    #hud-small-panel, #hud-small-panel * { box-sizing: border-box; }
    /* Section header inside HUD (title, summary, prev/next) */
    #hud-small-panel .hud-section-header {
      width: 100%;
      text-align: left;
      color: var(--hud-text);
      background: var(--hud-panel-bg);
      backdrop-filter: blur(2px) saturate(140%);
      border: 1px solid var(--border);
      border-top: none; /* Remove top border */
      border-radius: 0; /* Square corners to match tour style */
      
    }
    /* Block B: reset positioning when panels are inside the container (desktop) */
    #hud-container #hud-small-panel { position: static; width: 280px; }
    #hud-container #hud-big-panel { position: static; width: 580px; }

    /* HUD Container: fixed, centered wrapper to mirror working layout */
    #hud-container {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      display: none;              /* controlled by JS */
      flex-direction: row;
      gap: 24px;
      z-index: 1000;
    }
    /* Inside container: refine child layouts matching working variant */
    #hud-container #hud-small-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: none;
      border: none;
    }
    #hud-container #hud-big-panel {
      max-height: calc(100vh - 200px) !important;  /* limit height to enable scroll */
      height: auto !important;
      overflow-y: auto !important;                 /* enable scroll in container mode */
      overflow-x: hidden !important;            /* avoid nested horizontal scroll */
      overscroll-behavior: contain !important;  /* prevent scroll chaining */
      background: var(--hud-panel-bg);
      backdrop-filter: blur(2px) saturate(140%);
      border: 1px solid var(--border);
      border-top: none; /* Remove top border */
      border-radius: 0; /* Square corners to match tour style */
      padding: 20px;
      color: var(--hud-text);
      line-height: 1.5;
      white-space: pre-line;
      box-sizing: border-box;        /* keep padding inside bounds */
      overflow-wrap: anywhere;       /* wrap long tokens */
      word-break: break-word;        /* break long words */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    #hud-container #hud-big-panel::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    /* Headings in container big panel main text use tour style */
    #hud-container #hud-big-panel h1,
    #hud-container #hud-big-panel h2,
    #hud-container #hud-big-panel h3,
    #hud-container #hud-big-panel h4,
    #hud-container #hud-big-panel h5,
    #hud-container #hud-big-panel h6,
    .hud-active #hud-container #hud-big-panel h1,
    .hud-active #hud-container #hud-big-panel h2,
    .hud-active #hud-container #hud-big-panel h3,
    .hud-active #hud-container #hud-big-panel h4,
    .hud-active #hud-container #hud-big-panel h5,
    .hud-active #hud-container #hud-big-panel h6 {
      font: 600 20px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
    }
    #hud-small-panel .hud-section-title {
      margin: 0 0 6px 0;
      
      font-weight: 400;
      color: var(--HUD/Text/Base);
    }
    #hud-small-panel .hud-section-summary {
      margin: 10px 0 18px 0;  /* increased top and bottom margins by 10px */
      
      line-height: 1.4;
      color: var(--HUD/Text/Muted);
    }
    #hud-small-panel .hud-section-nav {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    #hud-small-panel .hud-section-nav a {
      font-size: 16px;
      font-weight: 200 !important;
      color: var(--tour-text-muted) !important;  /* same color as links panel */
      text-decoration: none;
      padding: 4px 6px;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    /* PHASE C3.3: Hover styles moved to main.css with proper specificity */
    #hud-small-panel button {
      padding: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--hud-text-muted);
      background: var(--hud-panel-bg-mobile);
      backdrop-filter: blur(2px) saturate(140%);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    
    /* Desktop: vertical layout */
    #hud-small-panel button {
      width: 100%;
    }
    
    /* Mobile: horizontal layout */
    @media (max-width: 479px) {
      #hud-small-panel {
        flex-direction: row !important;
        flex-wrap: wrap;
      }
      #hud-small-panel button {
        width: auto !important;
        flex: 1 1 auto !important;
        min-width: 0;
      }
    }
    #hud-small-panel button:hover {
      color: var(--Color/Accent/Primary);
      background: var(--Color/State/Hover/Background);
    }
    #hud-small-panel button.active-tab {
      color: var(--HUD/Text/Base);
      background: var(--Color/State/Active/Background);
      border-color: var(--Color/Accent/Primary);
      box-shadow: 0 0 0 1px var(--Color/Effect/Glow) inset;
    }

    /* === Custom header, tagline and links panel for the portfolio site === */
    header#site-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 14px;
      /* Use theme-aware header variables - same layout, different colors */
      background: var(--header-bg, var(--panel-ghost));
      border-bottom: 1px solid var(--header-border, var(--border));
      backdrop-filter: blur(20px) saturate(160%);
      font-family: inherit;
    }
    /* Keep blur effect in HUD mode (reduced intensity for performance) */
    .hud-active header#site-header {
      backdrop-filter: blur(20px) saturate(160%);
      background: var(--header-bg-hud, var(--hud-panel-bg-mobile));
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo .name {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.2px;
      /* Use theme-aware color variable instead of hardcoded color */
      color: var(--Header/Logo/Name, #CFE8FF);
      white-space: nowrap;
    }
    .header-logo .tagline {
      margin-left: 12px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 400;
      white-space: nowrap;
    }
    .header-spacer { flex: 1; }
    .header-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px !important; /* unify size across viewports */
      height: 36px; /* fixed visual height */
      line-height: 1;
      box-sizing: border-box;
      font-size: 14px;
      font-weight: 500;
      color: var(--muted);
      background: transparent;
      border: 1px solid transparent; /* stabilize size on hover */
      border-radius: 0;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .header-btn:hover {
      color: var(--Header/Button/HoverText);
      background: var(--Header/Button/HoverBg);
    }
    .header-btn:active {
      color: var(--Color/Accent/Hover);
      background: var(--Color/State/Active/Background);
    }
    /* Normalize theme toggle container children to button size */
    #theme-toggle-container { display: flex; align-items: center; gap: 8px; }
    /* Normalize all header controls to identical size and states */
    #theme-toggle-container > * {
      width: 44px; height: 44px; padding: 10px;
      border-radius: 0 !important;
      display: inline-flex; align-items: center; justify-content: center;
      box-sizing: border-box;
      background: transparent; color: var(--muted);
      border: 1px solid transparent; cursor: pointer;
      line-height: 1; gap: 0;
      pointer-events: auto !important;
      z-index: 2001 !important;
    }
    /* Ensure theme toggle button is clickable */
    #theme-toggle-btn {
      pointer-events: auto !important;
      z-index: 2001 !important;
      cursor: pointer !important;
      position: relative;
    }
    /* Hover/active match header buttons */
    #theme-toggle-container > *:hover { color: var(--Color/Accent/Primary); background: var(--Color/State/Hover/Background); }
    #theme-toggle-container > *:active { color: var(--Color/Accent/Hover); background: var(--Color/State/Active/Background); }
    /* Icon sizes and color unification */
    #theme-toggle-container img, #tour-restart-btn img { width: 24px; height: 24px; display: block; }
    #theme-toggle-container svg, #tour-restart-btn svg { width: 24px; height: 24px; }
    /* Project gray color for icons */
    :root { --icon-gray: var(--Header/Button/Text); }
    #theme-toggle-container svg { fill: var(--icon-gray) !important; stroke: var(--icon-gray) !important; }
    #tour-restart-btn img { filter: brightness(0) saturate(100%) invert(73%) sepia(5%) saturate(342%) hue-rotate(176deg) brightness(92%) contrast(89%); }
    /* Hover: accent tint, matches buttons */
    #theme-toggle-container > *:hover svg { fill: var(--Color/Accent/Primary) !important; stroke: var(--Color/Accent/Primary) !important; }
    #tour-restart-btn:hover img { filter: brightness(0) saturate(100%) invert(66%) sepia(58%) saturate(618%) hue-rotate(186deg) brightness(101%) contrast(101%); }
    /* === Custom header, tagline and links panel for the portfolio site === */
    /* Header styling improvements for the HUD */
    #hud-small-panel .hud-section-header {
      position: relative;
      padding: 12px;
      background: var(--hud-panel-bg);
      backdrop-filter: blur(2px) saturate(140%);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    #hud-small-panel .hud-section-title {
      margin: 0 0 4px 0;
      
      font-weight: 400;
      color: var(--HUD/Text/Base);
    }
    #hud-small-panel .hud-section-summary {
      margin: 10px 0 18px 0;  /* increased top and bottom margins by 10px */
      
      line-height: 1.4;
      color: var(--muted);
    }
    #hud-small-panel .hud-section-nav {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
    }
    #hud-small-panel .hud-section-nav a {
      flex: 1 1 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      font-size: 16px;
      font-weight: 200 !important;
      color: var(--tour-text-muted) !important;  /* same color as links panel */
      background: var(--hud-panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
      cursor: pointer;
      pointer-events: auto; /* Ensure links receive clicks */
      touch-action: manipulation; /* Enable touch on mobile */
    }
    /* PHASE C3.3: Hover styles moved to main.css with proper specificity */
    /* Close button styling for the header */
    #hud-small-panel .hud-close-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 6px;
      font-size: 16px;
      font-weight: 600;
      color: var(--tour-text-muted) !important;  /* same color as links panel */
      background: var(--hud-panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s;

      /* Ensure the close button remains a small icon rather than stretching like the tab buttons. */
      width: auto !important;
      height: auto !important;
      flex: 0 0 auto;
    }
    /* PHASE C3.3: Hover styles moved to main.css with proper specificity */

    /* Responsive layout for tablet screens: stack panels vertically */
    @media (max-width: 767px) {
      #hud-container {
        top: 120px;
        flex-direction: column;
        gap: 16px;
        width: 90%;
        overflow-y: auto;              /* tablet: scroll container */
      }
      #hud-container #hud-small-panel {
        width: 100%;
      }
      #hud-container #hud-big-panel { width: 100%; }
      #hud-small-panel .hud-section-title {
        font-size: 18px;
      }
      #hud-small-panel .hud-section-summary {
        font-size: 16px;
      }
      #hud-small-panel button {
        font-size: 15px;
      }
    }

    /* Responsive layout for mobile screens: further increase text sizes and
       allow the big panel to use more vertical space */
    @media (max-width: 479px) {
      #hud-container {
        top: 72px;
        width: 94%;
      }
      #hud-small-panel .hud-section-title {
        font-size: 20px;
      }
      #hud-small-panel .hud-section-summary {
        font-size: 16px;
      }
      #hud-small-panel .hud-section-nav a {
        font-size: 16px !important;  /* same size as main text */
      }
    }
    /* Removed floating tagline; tagline now integrated with header logo */
    #links-panel {
      position: fixed;
      top: 90px;
      right: 20px;
      width: 420px; /* desktop: larger than before */
      z-index: 1850;
      display: none;
      flex-direction: column;
      gap: 13px; /* line spacing increased by 5px */
      padding: 12px 12px 10px 12px;
      /* Container stays transparent; items style themselves */
      background: none;
      border: none;
      border-radius: 12px;
    }
    /* Mobile: full width and centered */
    @media (max-width: 767px) {
      #links-panel {
        left: 20px;
        right: 20px;
        transform: none;
        width: auto;
        max-width: none;
        top: 72px;
      }
    }
    .link-row a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      text-decoration: none;
      font-size: 16px !important;  /* same size as main text */
      font-weight: 400;
      /* Override inherited colour from body with !important to ensure the muted tone */
      color: var(--muted) !important;
      background: transparent;
      border: none;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .link-row a:hover {
      color: var(--Link/HoverText) !important;
      background: var(--Link/HoverBg) !important;
    }
    .link-kicker {
      font-size: 12px;
      color: var(--HUD/Text/Muted);
      opacity: 0.75;
      padding: 0 12px; /* align with link rows */
      margin-top: 10px; /* shift down by 10px */
    }

    /* Close button for links panel */
    #links-panel .close-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 18px;
      color: var(--HUD/Text/Muted);
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.2s;
    }
    #links-panel .close-btn:hover {
      color: var(--HUD/Text/Base);
    }
    /* Ensure HUD buttons look slightly bolder: we already set weight via main
       declaration. This override is removed to avoid conflicting with the
       unified button styles. */
    /* Removed redundant HUD weight override */

    /* Orbit mode banner */
    #mode-banner {
      position: fixed;
      top: 75px; /* 56px + 19px = 75px */
      left: 50%;
      transform: translateX(-50%);
      z-index: 2100;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--tour-text-secondary);
      background: var(--hud-panel-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      backdrop-filter: blur(8px);
      display: none;
      pointer-events: none;
    }
    /* In HUD mode, banner should be below overlay (z-index 900) and hud-backdrop (z-index 940) */
    .hud-active #mode-banner {
      z-index: 800 !important;
    }
    /* Hide orbit banner on mobile */
    @media (max-width: 767px) {
      #mode-banner { display: none !important; }
    }
    /* Also remove blur on big HUD panels during HUD activity */
    .hud-active #hud-big-panel,
    .hud-active #hud-container #hud-big-panel {
      backdrop-filter: none !important;
    }
    /* HUD mode: square corners everywhere */
    .hud-active #hud-container,
    .hud-active #hud-container *,
    .hud-active #hud-small-panel,
    .hud-active #hud-small-panel *,
    .hud-active #hud-big-panel,
    .hud-active #hud-big-panel *,
    .hud-active .hud,
    .hud-active .hud * {
      border-radius: 0 !important;
    }
    /* Remove borders from all elements globally */
    body * { border: none !important; }
    /* In HUD mode render grid canvas below header and text panels, but above overlay */
    .hud-active #grid-canvas { z-index: 950 !important; pointer-events: none; }
    /* In Links mode raise grid above links overlay backdrop but below the panel content */
    .links-active #grid-canvas { z-index: 1845 !important; pointer-events: none; }
    /* Background grid under HUD overlay */
    #grid-canvas-bg { position: fixed; inset: 0; pointer-events: none; z-index: 890; }
    /* On mobile, keep same layering as desktop: base lines above overlay */
    @media (max-width: 767px) {
      .hud-active #grid-canvas { z-index: 950 !important; }
      .links-active #grid-canvas { z-index: 1845 !important; }
      body.tour-active #grid-canvas { z-index: 2490 !important; }
      #grid-canvas-bg { z-index: 880; }
      /* Ensure panels remain above base lines */
      .hud-active #hud-container,
      .hud-active #hud-big-panel,
      .hud-active #hud-small-panel { z-index: 1000 !important; }
      .links-active #links-panel { z-index: 1850 !important; }
    }

    /* Force square corners globally across states */
    button,
    button:hover,
    button:active,
    button:focus,
    .header-btn,
    .header-btn:hover,
    .header-btn:active,
    .header-btn:focus,
    a,
    a:hover,
    a:active,
    a:visited,
    input,
    input:hover,
    input:focus,
    select,
    select:hover,
    select:focus,
    textarea,
    textarea:hover,
    textarea:focus,
    .btn,
    .btn:hover,
    .btn:active,
    .btn:focus,
    .chip,
    .chip:hover,
    .chip:active,
    .chip:focus,
    .panel,
    .panel:hover,
    .panel:active,
    .panel:focus,
    .card,
    .card:hover,
    .card:active,
    .card:focus,
    #links-panel .link-row a,
    #links-panel .link-row a:hover,
    #links-panel .link-row a:active,
    #links-panel .link-row a:visited,
    #links-panel .close-btn,
    #links-panel .close-btn:hover,
    #links-panel .close-btn:active,
    #links-panel .close-btn:focus {
      border-radius: 0 !important;
    }
    /* During tour, grid should be visible through the card */
    /* Grid is below card but visible through transparent card background */
    body.tour-active #grid-canvas { z-index: 2490 !important; pointer-events: none; }
    /* Default browser cursors in use */
    .hud-active button,
    .hud-active a,
    .hud-active input,
    .hud-active select,
    .hud-active textarea,
    .hud-active .chip,
    .hud-active .label,
    .hud-active .link-row a,
    .hud-active .btn,
    .hud-active .panel,
    .hud-active .card {
      border-radius: 0 !important;
    }

    

    
    /* HUD mode: square corners everywhere */
    .hud-active #hud-container,
    .hud-active #hud-container *,
    .hud-active #hud-small-panel,
    .hud-active #hud-small-panel *,
    .hud-active #hud-big-panel,
    .hud-active #hud-big-panel *,
    .hud-active .hud,
    .hud-active .hud * {
      border-radius: 0 !important;
    }
    .hud-active button,
    .hud-active a,
    .hud-active input,
    .hud-active select,
    .hud-active textarea,
    .hud-active .chip,
    .hud-active .label,
    .hud-active .link-row a,
    .hud-active .btn,
    .hud-active .panel,
    .hud-active .card {
      border-radius: 0 !important;
    }
    /* Disable page scroll when HUD is active */
    /* On mobile, allow container scroll but prevent body scroll */
    body.hud-active,
    html.hud-active {
      overflow: hidden !important;
      height: 100% !important;
      position: fixed !important;
      width: 100% !important;
    }
    /* On mobile/tablet, allow HUD container to scroll */
    @media (max-width: 767px) {
      body.hud-active,
      html.hud-active {
        position: fixed !important;
        overflow: hidden !important;
      }
      #hud-container {
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: contain !important;
      }
    }
  
/* === Strict overrides: no borders on HUD controls; mobile containment === */
#hud-small-panel .hud-section-nav a,
#hud-small-panel .hud-close-btn {
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
}
/* PHASE C3.3: Hover styles moved to main.css with proper specificity */
/* Big panel: contain within viewport; avoid horizontal overflow */
/* REMOVED to restore fixed desktop layout; container/mobile rules remain */
/*
#hud-big-panel {
  width: 100%;
  max-width: 100vw;
  height: auto;
  max-height: calc(100dvh - 260px);
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
  overflow-wrap: anywhere;
  word-break: break-word;
}
*/
/* When big panel is inside the responsive container */
/*
#hud-container #hud-big-panel {
  width: 100%;
  max-width: 100vw;
  height: auto;
  max-height: calc(100dvh - 260px);
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
  overflow-wrap: anywhere;
  word-break: break-word;
}
*/
/* Tablet */
@media (max-width: 767px) {
  /* removed duplicate - using mobile styles from line 740 */
}
/* Mobile */
@media (max-width: 479px) {
  /* Show orbit toggle on mobile */
  #mobile-orbit-toggle {
    display: flex !important;
  }
}


/* === Patch: keep Prev/Next on one line === */
#hud-small-panel .hud-section-nav {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  flex-wrap: nowrap; /* do not wrap to second line */
}
#hud-small-panel .hud-section-nav a {
  flex: 0 0 auto !important;   /* don't stretch, don't wrap */
  white-space: nowrap !important;
  padding: 2px 6px !important;  /* tighter to fit in one row */
  font-weight: 200 !important;
  line-height: 1.1 !important;
}
/* Ensure link in big panel has same weight as main text */
#hud-big-panel .hud-tab-link {
  font-weight: 200 !important;
  color: var(--HUD/Text/Muted) !important;  /* same color as links panel */
}
#hud-big-panel .hud-tab-link:hover {
  color: var(--Color/Accent/Primary) !important;  /* same hover color as links panel */
}
/* Style links in solution text */
#hud-big-panel a[target="_blank"]:not(.hud-tab-link) {
  color: var(--HUD/Text/Muted) !important;  /* same color as links panel */
  text-decoration: none;
  font-weight: 200 !important;
  font-size: inherit !important;  /* same size as main text */
  border-bottom: 1px solid var(--Color/Dark/Border/Subtle);
  transition: border-color 0.2s, color 0.2s;
}
#hud-big-panel a[target="_blank"]:not(.hud-tab-link):hover {
  color: var(--Color/Accent/Primary) !important;  /* same hover color as links panel */
  border-bottom-color: var(--Color/Accent/Primary);
}

/* Mobile orbit mode toggle */
#mobile-orbit-toggle {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 900;
  display: flex;
}

#toggle-orbit-btn {
  background: var(--hud-panel-bg);
      border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 14px;
      color: var(--text);
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 0 0 1px var(--Color/Dark/Border/Subtle) inset, 0 2px 10px var(--Color/Effect/Shadow/Soft);
  white-space: nowrap;
  opacity: 0.96;
}

#toggle-orbit-btn:hover {
  background: var(--Color/State/Hover/Background);
  border-color: var(--Color/Accent/Primary);
  color: var(--HUD/Text/Base);
}

#toggle-orbit-btn.active {
  background: var(--Color/State/Active/Background);
  border-color: var(--Color/Accent/Primary);
  color: var(--Color/Accent/Primary);
}

#toggle-orbit-btn.active:hover {
  border-color: var(--Color/Accent/Hover);
  color: var(--HUD/Text/Base);
}

#toggle-orbit-icon {
  width: 24px;
  height: 24px;
  display: block;
  filter: brightness(0) saturate(100%) invert(65%) sepia(8%) saturate(443%) hue-rotate(177deg) brightness(94%) contrast(92%);
  transition: filter 200ms ease;
}

/* Active orbit mode: tint icon to accent blue */
#toggle-orbit-btn.active #toggle-orbit-icon {
  filter: brightness(0) saturate(100%) invert(42%) sepia(66%) saturate(1675%) hue-rotate(189deg) brightness(101%) contrast(98%);
}

/* Disable smooth scroll globally */
html {
  scroll-behavior: auto;
}

/* === Mobile: scroll the HUD container instead of the big panel to guarantee bottom visibility === */
@media (max-width: 479px) {
  #hud-container {
    top: 64px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 94% !important;
    height: auto !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding-bottom: 24px !important;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain !important;
    /* hide scrollbar on mobile */
    scrollbar-width: none;
  }
  #hud-container::-webkit-scrollbar { width: 0; height: 0; }
  #hud-container #hud-big-panel {
    height: auto !important;
    max-height: none !important;
    overflow: visible !important;
    padding-bottom: 40px !important;
  }
  /* Увеличиваем крестик закрытия на мобильных */
  #hud-small-panel .hud-close-btn {
    font-size: 22px !important;
    padding: 6px 8px !important;
    min-width: 36px !important;
    min-height: 36px !important;
  }
}

/* Ultra-narrow safeguard */
@media (max-width: 360px) {
  #hud-small-panel .hud-section-nav a {
    font-size: 16px !important;
    font-weight: 200 !important;
    padding: 2px 4px !important;
  }
}


/* Mobile header: hide logo, left-align buttons */
@media (max-width: 479px) {
  header#site-header { justify-content: flex-start !important; gap: 8px !important; }
  header#site-header .header-logo { display: none !important; }
  header#site-header .header-spacer { display: none !important; }
  .header-btn { padding: 8px 12px !important; height: 36px; }
  /* Keep btn-demo visible - это кнопка "Демо" для быстрого доступа к контенту */
  /* Настоящая кнопка темы: #theme-toggle-btn (создаётся hud-manager.js, живёт в #theme-toggle-container) */
  #btn-demo { display: inline-flex !important; }
}


/* === HUD title font refinement === */
#hud-small-panel .hud-section-title {
  font-weight: 400 !important;  /* same weight as labels for consistency */
  font-size: 15px !important;
  letter-spacing: 0.2px;
}
#hud-small-panel .hud-section-summary {
  font-weight: 400 !important;
  font-size: 16px !important;
  color: #A5B4C3 !important;
}


/* === Tablet: mirror mobile behavior (container scroll, tail always reachable) === */
@media (max-width: 767px) {
  #hud-container {
    top: 72px !important;
    bottom: 12px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 94% !important;
    height: auto !important;
    max-height: none !important;
    overflow-y: auto !important;          /* scroll on container */
    overflow-x: hidden !important;
    padding-bottom: 24px !important;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain !important;
    /* hide scrollbar on tablet */
    scrollbar-width: none;
  }
  #hud-container::-webkit-scrollbar { width: 0; height: 0; }
  #hud-container #hud-big-panel {
    width: 100% !important;
    max-width: 100vw !important;
    height: auto !important;
    max-height: none !important;          /* let it grow; container handles scroll */
    overflow: visible !important;
    padding-bottom: 16px !important;      /* ensure last line/link is not cut */
    box-sizing: border-box !important;
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
  }
  /* Keep Prev/Next in one row on tablet too */
  #hud-small-panel .hud-section-nav {
    flex-wrap: nowrap !important;
  }
  #hud-small-panel .hud-section-nav a {
    flex: 0 0 auto !important;
    white-space: nowrap !important;
    padding: 4px 8px !important;
    line-height: 1.4 !important;
    font-size: 16px !important;  /* Единый размер с мобильной версией */
    font-weight: 200 !important;
  }
}

/* Размер шрифта кнопок навигации для мобильных (переопределяет планшетный стиль) */
@media (max-width: 479px) {
  #hud-small-panel .hud-section-nav a {
    font-size: 16px !important;
    font-weight: 200 !important;
    padding: 4px 8px !important;
    white-space: nowrap !important;
    flex: 0 0 auto !important;
    line-height: 1.4 !important;
  }
}


/* === Tablet header: show only logo (no tagline) and buttons === */
@media (min-width: 480px) and (max-width: 767px) {
  header#site-header { justify-content: space-between !important; gap: 12px !important; }
  header#site-header .header-logo { display: flex !important; align-items: center !important; }
  header#site-header .header-logo .tagline { display: none !important; } /* убрать подзаголовок */
  /* Кнопки в одну строку, компактные отступы */
  .header-btn { padding: 8px 12px !important; height: 36px; }
  /* #btn-demo — кнопка "Демо" для быстрого доступа к контенту, всегда видна */
  /* Настоящая кнопка темы: #theme-toggle-btn (создаётся hud-manager.js, живёт в #theme-toggle-container) */
  #btn-demo { display: inline-flex !important; }
}


/* === Unified thin dark scrollbars (mobile-like) === */
html, body { scrollbar-gutter: stable; }

/* Firefox */
html, body,
#overlay {
  scrollbar-width: thin;
  scrollbar-color: #3B4A5F transparent;
}
#hud-big-panel {
  scrollbar-width: none;
  scrollbar-color: transparent transparent;
}

/* Chromium/WebKit */
html::-webkit-scrollbar,
body::-webkit-scrollbar,
#overlay::-webkit-scrollbar { width: 8px; height: 8px; }
#hud-big-panel::-webkit-scrollbar { width: 0px; height: 0px; display: none; }

html::-webkit-scrollbar-track,
body::-webkit-scrollbar-track,
#overlay::-webkit-scrollbar-track { background: transparent; }
#hud-big-panel::-webkit-scrollbar-track { background: transparent; display: none; }

html::-webkit-scrollbar-thumb,
body::-webkit-scrollbar-thumb,
#overlay::-webkit-scrollbar-thumb {
  background: rgba(59, 74, 95, 0.9);
  border-radius: 8px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
#hud-big-panel::-webkit-scrollbar-thumb {
  display: none;
}

#overlay:hover::-webkit-scrollbar-thumb,
#hud-big-panel:hover::-webkit-scrollbar-thumb,
html:hover::-webkit-scrollbar-thumb,
body:hover::-webkit-scrollbar-thumb {
  background: rgba(59, 74, 95, 1);
}

/* === HUD Grid hologram effect === */
.grid-line {
  pointer-events: none;
  will-change: opacity, filter, transform, background-position;
  /* dashed via repeating gradient; color set via --c */
  --c: var(--grid-color);
  --dash: 10px;   /* length of visible segment */
  --gap: 8px;     /* length of gap */
  --phase: 0px;   /* starting offset */
  background: none;
  box-shadow:
    0 0 3px var(--grid-color),
    0 0 8px var(--grid-color);
  mix-blend-mode: screen;
  opacity: var(--grid-opacity);
  filter: hue-rotate(var(--grid-hue, 0deg)) saturate(var(--grid-sat, 1.1));
}
.grid-line::after {
  content: '';
  position: absolute; inset: 0;
  pointer-events: none;
}
.grid-line.h { /* horizontal dashed */
  background-image: repeating-linear-gradient(
    90deg,
    var(--c) 0 calc(var(--dash)),
    rgba(255,255,255,0) calc(var(--dash)) calc(calc(var(--dash) + var(--gap)))
  );
  background-size: calc(var(--dash) + var(--gap)) 100%;
  background-position: var(--phase, 0px) 0;
}
.grid-line.h::after {
  /* горизонтальная линия: лёгкий бегущий блик */
  background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(200,240,255,0.35) 50%, rgba(255,255,255,0) 100%);
  background-size: 220% 100%;
  background-position: var(--shimmerH, 0%) 0;
}
.grid-line.v { /* vertical dashed */
  background-image: repeating-linear-gradient(
    180deg,
    var(--c) 0 calc(var(--dash)),
    rgba(255,255,255,0) calc(var(--dash)) calc(calc(var(--dash) + var(--gap)))
  );
  background-size: 100% calc(var(--dash) + var(--gap));
  background-position: 0 var(--phase, 0px);
}
.grid-line.v::after {
  /* вертикальная линия: блик сверху вниз */
  background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(200,240,255,0.35) 50%, rgba(255,255,255,0) 100%);
  background-size: 100% 220%;
  background-position: 0 var(--shimmerV, 0%);
}
/* Убраны CSS-анимации; значения управляются из движка через CSS-переменные */

/* Mobile performance: remove will-change on mobile */
@media (max-width: 767px) {
  .grid-line {
    will-change: auto; /* Remove will-change on mobile for better performance */
  }
}

/* Final override: hide container scrollbar on mobile/tablet (Chromium/WebKit + Firefox) */
@media (max-width: 767px) {
  #hud-container { scrollbar-width: none !important; }
  #hud-container::-webkit-scrollbar { width: 0 !important; height: 0 !important; }
  #hud-container::-webkit-scrollbar-thumb { background: transparent !important; }
  #hud-container { scrollbar-gutter: auto; }
}


/* remove stray flex override; container visibility controlled above */

/* === Header buttons default spacing via .header-spacer (override removed) === */

/* (Reset rules are defined once above; duplicates removed) */

  /* === HUD spacing normalization: equal top padding in headers and big panel === */
  #hud-small-panel .hud-section-header { padding: 16px 12px 12px 12px; }
  #hud-big-panel, #hud-container #hud-big-panel { padding-top: 16px; }
  #hud-big-panel > :first-child, #hud-container #hud-big-panel > :first-child { margin-top: 0 !important; }

  /* === Tour restart icon next to theme toggle === */
  #tour-restart-btn { display:inline-flex; align-items:center; justify-content:center; width: 44px; height: 44px; margin-left: 6px; border:1px solid var(--border); border-radius: 10px; background: transparent; color: var(--tour-text-muted); cursor: pointer; transition: background .2s, color .2s, border-color .2s; }
  #tour-restart-btn:hover { background: var(--Color/State/Hover/Surface); color: var(--tour-text-secondary); border-color: var(--Color/Accent/Primary); }
  #tour-restart-btn:active { color: var(--tour-text-secondary); border-color: var(--Color/Accent/Hover); }
  #tour-restart-btn:focus { outline: 2px solid var(--Color/Accent/Primary); outline-offset: 2px; }
  #tour-restart-btn .icon { font-size: 18px; line-height: 1; }

</style>
</head>
<body>

<!-- Preloader overlay -->
<div id="preloader-overlay" aria-hidden="true">
  <iframe id="preloader-frame" src="" title="UX4AI Preloader" loading="eager"></iframe>
  <style>
    #preloader-overlay {
      position: fixed; inset: 0; z-index: 3000;
      /* PHASE C2: Use token with fallback for FOUC prevention */
      background: var(--Color/Dark/Background/Primary, #0B0F14); /* match theme bg to avoid flash */
      display: flex; align-items: center; justify-content: center;
    }
    #preloader-overlay.hidden { display: none !important; }
    #preloader-frame { width: 100%; height: 100%; border: 0; }
  </style>
</div>

<!-- Guided Tour Overlay (A/B/C) -->
<div id="tour-overlay" aria-hidden="true" class="hidden" inert>
  <div class="tour-backdrop"></div>
  <div class="tour-card" role="dialog" aria-modal="true" aria-labelledby="tour-title" aria-describedby="tour-text">
    <div class="tour-header">
      <h2 id="tour-title"></h2>
      <p class="tour-sub" id="tour-sub"></p>
    </div>
    <div class="tour-body">
      <p id="tour-text"></p>
    </div>
    <div class="tour-interactives" id="tour-interactives" aria-hidden="true">
      <noscript>
        <div class="tour-interactives-fallback">
          <p style="color: var(--tour-text-muted); font: 400 14px/1.3 ui-sans-serif, system-ui; text-align: center; margin: 0;">
            Интерактивные элементы требуют JavaScript
          </p>
        </div>
      </noscript>
    </div>
    <div class="tour-actions" id="tour-actions"></div>
    <div class="tour-frame-lines" aria-hidden="true"></div>
  </div>
  <style>
    #tour-overlay { position: fixed; inset: 0; z-index: 2500; display: flex; align-items: center; justify-content: center; }
    #tour-overlay.hidden { display: none !important; }
    #tour-overlay .tour-backdrop { position:absolute; inset:0; background: var(--tour-backdrop); backdrop-filter: blur(2px) saturate(120%); z-index: 1; }
    @media (max-width: 767px) {
      /* Disable backdrop-filter on mobile, but keep visual effect with gradients and shadows */
      #tour-overlay .tour-backdrop { 
        backdrop-filter: none; 
        background: var(--tour-backdrop);
        /* Add subtle gradient for depth - use CSS variables for light theme compatibility */
        background-image: radial-gradient(circle at center, var(--tour-backdrop) 0%, var(--tour-backdrop) 100%);
        opacity: 0.7;
      }
      #tour-overlay .tour-card { 
        backdrop-filter: none !important; 
        /* Use more transparent background for better visibility - increased transparency */
        background: var(--tour-card-bg-mobile) !important;
        /* Remove border-radius and top border to match desktop style */
        border-radius: 0 !important;
        border-top: none !important;
        /* Add subtle border glow and inner highlight for glass effect - remove top border */
        box-shadow: 
          0 12px 40px rgba(0,0,0,0.45),
          inset 0 -1px 0 rgba(0,0,0,0.2),
          0 0 0 1px var(--Color/Dark/Border/Subtle),
          0 -1px 0 transparent !important; /* Remove top border shadow */
        /* Add pseudo-element for additional glass effect */
        position: relative;
      }
      /* Remove top border effect - no pseudo-element needed */
      #tour-overlay .tour-card::before {
        display: none;
      }
      /* Ensure content is above pseudo-element */
      #tour-overlay .tour-card > * {
        position: relative;
        z-index: 1;
      }
    }
    /* HUD-like styling: straight corners; no inner grid - grid visible through card */
    #tour-overlay .tour-card { position: relative; width: min(720px, 92vw);
      background: var(--tour-card-bg);
      backdrop-filter: blur(2px) saturate(140%);
      border:1px solid var(--border); border-top: none; border-radius: 0; box-shadow: 0 12px 40px var(--Color/Effect/Shadow/Medium); padding: 20px 20px 20px 20px; color: var(--tour-text); z-index: 2; }
    /* Disable per-card grid to keep through-grid effect like HUD */
    #tour-overlay .tour-frame-lines { display:none; }
    /* Close link inside actions */
    #tour-overlay .tour-actions .close-link { 
      background: transparent; border: none; color: var(--tour-text-muted); text-decoration: none; 
      padding: 10px 14px; height: 44px; display:inline-flex; align-items:center; justify-content:center;
      font: 400 18px/1 ui-sans-serif, system-ui; box-sizing: border-box;
      opacity: 0.5;
    }
    #tour-overlay .tour-actions .close-link:hover { color: var(--tour-text-secondary); opacity: 1; }
    @media (min-width: 480px) {
      #tour-overlay .tour-actions .close-link { margin-left: auto; }
    }
    #tour-overlay .tour-header h2 { margin: 0 0 32px 0; font: 600 24px/1.3 ui-sans-serif, system-ui; color: var(--tour-text-secondary); white-space: pre-line; }
    #tour-overlay .tour-header .tour-sub { margin: 0 0 32px 0; color: var(--tour-text-muted); font: 400 18px/1.3 ui-sans-serif, system-ui; }
    /* Reduce sub margin when followed by links list (step 2) */
    #tour-overlay .tour-card.tour-step-2 .tour-header .tour-sub { margin-bottom: 8px !important; }
    /* Ensure consistent spacing: sub → content (16px), content → buttons (32px) */
    #tour-overlay .tour-body { margin-top: 0; }
    #tour-overlay .tour-body p { margin: 0 0 32px 0; color: var(--tour-text-body); font: 300 18px/1.3 ui-sans-serif, system-ui; }
    /* Icon color matching text color - use mask to inherit text color */
    #tour-overlay .tour-body p img { 
      filter: brightness(0) saturate(100%) invert(72%) sepia(2%) saturate(1000%) hue-rotate(180deg);
    }
    /* Tour case links styled like HUD "contacts" links */
    #tour-overlay .tour-body .tour-list { 
      margin: 0 0 px 0; 
      padding: 0; 
      list-style: none; 
      display: flex; 
      flex-direction: column; 
      gap: 0; 
      align-items: flex-start; 
    }
    /* When list is inside p, remove p's margin and let list handle spacing */
    #tour-overlay .tour-body p:has(.tour-list) { margin: 0; }
    #tour-overlay .tour-body .tour-list li { margin: 0; line-height: 1; }
    #tour-overlay .tour-body .tour-list a {
      display: flex; 
      align-items: center;
      gap: 8px;
      text-decoration: none; 
      font: 400 18px/1 ui-sans-serif, system-ui;
      color: var(--tour-text-muted) !important; 
      background: transparent; 
      border: none; 
      border-radius: 0;
      transition: color 0.2s, background 0.2s;
    }
    /* Icon color matching link text color */
    #tour-overlay .tour-body .tour-list a img {
      filter: brightness(0) saturate(100%) invert(65%) sepia(5%) saturate(500%) hue-rotate(180deg);
      transition: filter 0.2s;
    }
    #tour-overlay .tour-body .tour-list a:hover { 
      color: var(--Link/HoverText) !important; 
      background: var(--Link/HoverBg) !important; 
    }
    /* Icon color on hover - match accent color */
    #tour-overlay .tour-body .tour-list a:hover img {
      filter: brightness(0) saturate(100%) invert(60%) sepia(100%) saturate(2000%) hue-rotate(200deg);
    }
    #tour-overlay .tour-body .tour-list a:visited { color: var(--tour-text-muted) !important; }
    #tour-overlay .tour-body .tour-list a:visited:hover { color: var(--Color/Accent/Primary) !important; }
    #tour-overlay .tour-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 0; }
      #tour-overlay .tour-actions .btn { 
      padding: 10px 14px; 
      border-radius: 0; 
      border:1px solid var(--border); 
      background: var(--tour-card-bg); 
      color: var(--tour-text-muted); 
      font: 400 18px/1 ui-sans-serif, system-ui; 
      text-decoration: none; 
      cursor: pointer; 
      transition: background .2s, color .2s, border-color .2s; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      height: 44px; 
      box-sizing: border-box;
      /* Критично для мобильных - улучшение отклика */
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(91, 156, 255, 0.2);
      pointer-events: auto !important;
      position: relative;
      z-index: 2503;
      /* Removed will-change and transform - they create unnecessary compositing layers */
    }
    #tour-overlay .tour-actions .btn:hover { background: var(--Color/State/Hover/Surface); color: var(--tour-text-secondary); border-color: var(--Color/Accent/Primary); }
    #tour-overlay .tour-actions .btn-primary { color: var(--tour-text-secondary); background: var(--Color/State/Selected/Background); border-color: var(--Color/Accent/Primary); }
    #tour-overlay .tour-actions .btn-primary:hover { background: var(--Color/State/Active/Background); }
    @media (max-width: 479px) {
      #tour-overlay { 
        align-items: flex-start; 
        padding-top: 20px; 
        padding-bottom: 40px;
        /* Исправление проблем с зависанием */
        position: fixed !important;
        z-index: 2500 !important;
        /* Removed will-change - not needed for static overlay */
      }
      /* Card fills the viewport height with 20px top and 40px bottom gutters; buttons at bottom */
      #tour-overlay .tour-card {
        padding: 16px;
        margin-left: auto; 
        margin-right: auto;
        display: flex; 
        flex-direction: column;
        width: calc(100vw - 40px);
        max-height: calc(100dvh - 60px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        /* Исправление проблем с откликом */
        position: relative;
        z-index: 2501;
        /* Предотвращение проблем с масштабированием и GPU acceleration */
        transform: scale(1) translateZ(0) !important;
        transform-origin: top center;
        /* Removed will-change: scroll-position - browser optimizes scrolling automatically */
      }
      #tour-overlay .tour-body { 
        flex: 0 0 auto; 
        overflow-y: visible;
        -webkit-overflow-scrolling: auto;
      }
      #tour-overlay .tour-actions { 
        flex-direction: column; 
        margin-top: auto;
        /* Улучшение отклика кнопок */
        position: relative;
        z-index: 2502;
      }
      #tour-overlay .tour-actions .btn { 
        width: 100%; 
        text-align: center;
        /* Критично для мобильных - улучшение отклика */
        min-height: 44px !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(91, 156, 255, 0.2);
        /* Предотвращение проблем с кликами */
        pointer-events: auto !important;
        position: relative;
        z-index: 2503;
        /* Remove transitions on mobile for instant feedback */
        transition: none !important;
        /* Removed will-change and transform - they create unnecessary compositing layers */
        /* Prevent text selection during touch */
        -webkit-user-select: none;
        user-select: none;
      }
    }
    /* Block page scroll when tour is active, but allow scrolling inside tour card */
    body.tour-active,
    html.tour-active {
      overflow: hidden !important;
      height: 100% !important;
      position: fixed !important;
      width: 100% !important;
      /* Предотвращение проблем с масштабированием на мобильных */
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    /* Разрешить скролл только внутри карточки тура */
    body.tour-active #tour-overlay .tour-card,
    body.tour-active #tour-overlay .tour-body {
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
    }
    /* В обычном режиме (не тур, не HUD) - разрешить скролл для 3D-сцены */
    @media (max-width: 767px) {
      html:not(.tour-active):not(.hud-active):not(.orbit-active) {
        overflow-x: hidden !important;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      body:not(.tour-active):not(.hud-active):not(.orbit-active) {
        overflow-x: hidden !important;
        /* Убрал !important - navigation.js управляет скроллом */
        overflow-y: auto;
        position: relative !important;
        /* Убрал touch-action - скролл управляется через navigation.js */
        -webkit-overflow-scrolling: touch;
        /* НЕ устанавливаем height - navigation.js устанавливает высоту динамически */
      }
      /* Не блокируем touch-action для #three-container - navigation.js управляет этим */
    }
    /* Allow scrolling inside tour card */
    #tour-overlay .tour-card {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100vh - 40px);
    }
    @media (max-width: 479px) {
      #tour-overlay .tour-card {
        max-height: calc(100dvh - 60px);
      }
    }
    
    /* Tour Interactives Styles */
    #tour-overlay .tour-interactives {
      margin-top: 32px;
      margin-bottom: 40px;
    }
    
    #tour-overlay .tour-interactives.loaded {
      opacity: 1;
    }
    
    /* Skeleton loaders */
    #tour-overlay .tour-interactives-skeleton {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    #tour-overlay .skeleton-header,
    #tour-overlay .skeleton-status {
      height: 24px;
      background: rgba(36, 48, 65, 0.5);
      border-radius: 0;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    
    #tour-overlay .skeleton-header {
      width: 60%;
    }
    
    #tour-overlay .skeleton-status {
      width: 80%;
      height: 16px;
    }
    
    #tour-overlay .skeleton-interactives {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    #tour-overlay .skeleton-item {
      height: 200px;
      background: rgba(36, 48, 65, 0.5);
      border-radius: 0;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    
    #tour-overlay .skeleton-cta {
      height: 44px;
      width: 60%;
      margin: 0 auto;
      background: rgba(36, 48, 65, 0.5);
      border-radius: 0;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    #tour-overlay .tour-interactives-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    /* Section header */
    #tour-overlay .tour-interactives-header {
      margin: 0 0 20px 0;
      font: 600 20px/1.3 ui-sans-serif, system-ui;
      color: var(--tour-text-secondary);
    }
    
    /* Status bar */
    #tour-overlay .tour-status-bar {
      padding: 8px 0;
      font: 400 14px/1.3 ui-sans-serif, system-ui;
      color: var(--tour-text-muted);
      border-bottom: 1px solid var(--HUD/Panel/Border);
    }
    
    /* Interactives layout - single column */
    
    #tour-overlay .tour-interactive {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    /* Interactive A - left aligned, vertical layout */
    #tour-overlay .tour-interactive-a {
      align-items: flex-start !important;
      display: flex !important;
      flex-direction: column !important;
      flex-wrap: nowrap !important;
    }
    
    /* Thermometer widget container */
    #tour-overlay .thermometer-widget-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }
    
    /* Thermometer widget header */
    #tour-overlay .thermometer-widget-header {
      margin: 0 0 12px 0;
      font: 600 24px/1.3 ui-sans-serif, system-ui;
      color: var(--tour-text-secondary);
      text-align: left;
      width: 100%;
      flex-shrink: 0;
      display: block;
    }
    
    /* Thermometer widget description */
    #tour-overlay .thermometer-widget-description {
      margin: 0 0 32px 0;
      font: 300 18px/1.3 ui-sans-serif, system-ui;
      color: #B8C3CF;
      text-align: left;
      width: 100%;
      flex-shrink: 0;
    }
    
    /* Thermometer container */
    #tour-overlay .thermometer-container {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
      width: 100%;
      flex-shrink: 0;
    }
    
    /* Override gap between segments and user feeling text */
    #tour-overlay .thermometer-segments-container + .thermometer-user-feeling {
      margin-top: -12px;
    }
    
    #tour-overlay .thermometer-container:focus {
      outline: 2px solid var(--Color/Accent/Primary);
      outline-offset: 2px;
    }
    
    /* Placeholder (top right corner) */
    #tour-overlay .readout-placeholder {
      position: absolute;
      top: 0;
      right: 0;
      max-width: 300px;
      width: 300px;
      font: 300 18px/1.3 ui-sans-serif, system-ui;
      color: #B8C3CF;
      transition: color 0.3s ease;
      text-align: right;
      word-wrap: break-word;
      white-space: pre-line;
    }
    
    /* Readout (above buttons, left-aligned) */
    #tour-overlay .thermometer-readout {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
      width: 100%;
    }
    
    #tour-overlay .readout-value {
      font: 600 56px/1 ui-sans-serif, system-ui;
      color: var(--tour-text-secondary);
      transition: color 0.3s ease;
    }
    
    #tour-overlay .readout-status {
      font: 400 14px/1.3 ui-sans-serif, system-ui;
      color: var(--tour-text-muted);
      transition: color 0.3s ease;
    }
    
    /* User feeling text (under buttons) */
    #tour-overlay .thermometer-user-feeling {
      margin: 4px 0 0 0;
      font: 300 18px/1.3 ui-sans-serif, system-ui;
      color: #B8C3CF;
      text-align: left;
      width: 100%;
    }
    
    /* Segments container (horizontal row) */
    #tour-overlay .thermometer-segments-container {
      display: flex;
      flex-direction: row;
      gap: 8px;
      flex-wrap: nowrap;
      width: 100%;
    }
    
    /* Thermometer segments */
    #tour-overlay .thermometer-segment {
      flex: 1;
      min-width: 0;
      padding: 12px 8px;
      background: var(--HUD/Panel/Bg);
      border: 1px solid var(--HUD/Panel/Border);
      color: var(--tour-text-muted);
      font: 400 14px/1 ui-sans-serif, system-ui;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Default zone colors (dim) */
    #tour-overlay .thermometer-segment.zone-1 {
      background: var(--Color/State/Success/Background);
      border-color: var(--Color/State/Success/Border);
      opacity: 0.3;
    }
    
    #tour-overlay .thermometer-segment.zone-2 {
      background: var(--Color/State/Success/Background);
      border-color: var(--Color/State/Success/Border);
      opacity: 0.3;
    }
    
    #tour-overlay .thermometer-segment.zone-3 {
      background: var(--Color/State/Warning/Background);
      border-color: var(--Color/State/Warning/Border);
      opacity: 0.3;
    }
    
    #tour-overlay .thermometer-segment.zone-4 {
      background: var(--Color/State/Warning/Background);
      border-color: var(--Color/State/Warning/Border);
      opacity: 0.3;
    }
    
    #tour-overlay .thermometer-segment.zone-5 {
      background: var(--Color/State/Error/Background);
      border-color: var(--Color/State/Error/Border);
      opacity: 0.3;
    }
    
    #tour-overlay .thermometer-segment:hover {
      background: var(--Color/State/Hover/Background);
      border-color: var(--Color/Accent/Primary);
      opacity: 0.8;
      transform: translateY(-1px);
    }
    
    #tour-overlay .thermometer-segment:focus {
      outline: 2px solid var(--Color/Accent/Primary);
      outline-offset: 2px;
    }
    
    /* Active state (bright colors) */
    #tour-overlay .thermometer-segment.active {
      color: var(--tour-text-secondary);
      font-weight: 600;
      opacity: 1;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #tour-overlay .thermometer-segment.zone-1.active {
      background: var(--Color/State/Success/BackgroundActive);
      border-color: var(--Color/State/Success/Border);
    }
    
    #tour-overlay .thermometer-segment.zone-2.active {
      background: var(--Color/State/Success/BackgroundActive);
      border-color: var(--Color/State/Success/Border);
    }
    
    #tour-overlay .thermometer-segment.zone-3.active {
      background: var(--Color/State/Warning/BackgroundActive);
      border-color: var(--Color/State/Warning/Border);
    }
    
    #tour-overlay .thermometer-segment.zone-4.active {
      background: var(--Color/State/Warning/BackgroundActive);
      border-color: var(--Color/State/Warning/Border);
    }
    
    #tour-overlay .thermometer-segment.zone-5.active {
      background: var(--Color/State/Error/BackgroundActive);
      border-color: var(--Color/State/Error/Border);
    }
    
    
    /* CTA Container */
    #tour-overlay .tour-cta-container {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    #tour-overlay .tour-cta-btn {
      flex: 1;
      min-width: 0;
      padding: 12px 8px;
      background: var(--Color/State/Active/Background);
      border: 1px solid var(--Color/Accent/Primary);
      color: var(--tour-text-secondary);
      font: 400 14px/1 ui-sans-serif, system-ui;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    #tour-overlay .tour-cta-btn:hover {
      background: var(--Color/State/Selected/Background);
      border-color: var(--Color/Accent/Hover);
    }
    
    #tour-overlay .tour-cta-btn:focus {
      outline: 2px solid var(--Color/Accent/Primary);
      outline-offset: 2px;
    }
    
    #tour-overlay .tour-cta-subtext {
      margin: 0;
      color: var(--tour-text-muted);
      font: 300 12px/1.3 ui-sans-serif, system-ui;
      text-align: center;
    }
    
    /* Desktop and Tablet styles (>=768px) */
    @media (min-width: 768px) {
      #tour-overlay .thermometer-widget-description {
        max-width: 100%;
      }
      
      #tour-overlay .thermometer-container {
        max-width: 100%;
      }
      
      #tour-overlay .thermometer-segments-container {
        max-width: 100%;
      }
      
      #tour-overlay .thermometer-user-feeling {
        max-width: 100%;
      }
      
      #tour-overlay .readout-value {
        font-size: 61px;
      }
      
      #tour-overlay .readout-status {
        font-size: 19px;
      }
      
      #tour-overlay .readout-placeholder {
        font-size: 18px;
        max-width: 400px;
        width: auto;
      }
    }
    
    /* Mobile Responsive */
    @media (max-width: 767px) {
      
      #tour-overlay .thermometer-widget-header {
        font-size: 20px;
      }
      
      #tour-overlay .readout-value {
        font-size: 42px;
      }
      
      #tour-overlay .readout-placeholder {
        font-size: 14px;
      }
      
      #tour-overlay .thermometer-segments-container {
        max-width: 352px;
      }
      
      #tour-overlay .skeleton-interactives {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 479px) {
      #tour-overlay .tour-cta-btn {
        width: 100%;
      }
    }
    
    /* Light theme support */
    .theme-light #tour-overlay .skeleton-header,
    .theme-light #tour-overlay .skeleton-status,
    .theme-light #tour-overlay .skeleton-item,
    .theme-light #tour-overlay .skeleton-cta {
      background: rgba(226, 232, 240, 0.5);
    }
    
    .theme-light #tour-overlay .tour-interactives-header {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .tour-status-bar {
      color: var(--tour-text-muted);
      border-bottom-color: var(--Color/Light/Border/Base);
    }
    
    .theme-light #tour-overlay .thermometer-widget-header {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .thermometer-widget-description {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .thermometer-segment {
      background: rgba(241, 245, 249, 0.6);
      border-color: var(--Color/Light/Border/Base);
      color: var(--tour-text-muted);
    }
    
    /* Default zone colors for light theme (dim) */
    .theme-light #tour-overlay .thermometer-segment.zone-1 {
      background: var(--Color/State/Success/Background);
      border-color: var(--Color/State/Success/Border);
      opacity: 0.4;
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-2 {
      background: var(--Color/State/Success/Background);
      border-color: var(--Color/State/Success/Border);
      opacity: 0.4;
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-3 {
      background: var(--Color/State/Warning/Background);
      border-color: var(--Color/State/Warning/Border);
      opacity: 0.4;
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-4 {
      background: var(--Color/State/Warning/Background);
      border-color: var(--Color/State/Warning/Border);
      opacity: 0.4;
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-5 {
      background: var(--Color/State/Error/Background);
      border-color: var(--Color/State/Error/Border);
      opacity: 0.4;
    }
    
    .theme-light #tour-overlay .thermometer-segment:hover {
      background: var(--Color/State/Hover/Background);
      border-color: var(--Color/Accent/Primary);
      opacity: 0.8;
    }
    
    .theme-light #tour-overlay .thermometer-segment.active {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-1.active {
      background: var(--Color/State/Success/BackgroundActive);
      border-color: var(--Color/State/Success/Border);
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-2.active {
      background: var(--Color/State/Success/BackgroundActive);
      border-color: var(--Color/State/Success/Border);
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-3.active {
      background: var(--Color/State/Warning/BackgroundActive);
      border-color: var(--Color/State/Warning/Border);
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-4.active {
      background: var(--Color/State/Warning/BackgroundActive);
      border-color: var(--Color/State/Warning/Border);
    }
    
    .theme-light #tour-overlay .thermometer-segment.zone-5.active {
      background: var(--Color/State/Error/BackgroundActive);
      border-color: var(--Color/State/Error/Border);
    }
    
    .theme-light #tour-overlay .readout-value {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .readout-placeholder {
      color: var(--tour-text-muted);
    }
    
    .theme-light #tour-overlay .readout-example {
      color: var(--tour-text-muted);
    }
    
    .theme-light #tour-overlay .thermometer-user-feeling {
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .readout-status {
      color: var(--tour-text-muted);
    }
    
    .theme-light #tour-overlay .tour-cta-subtext {
      color: var(--tour-text-muted);
    }
    
    .theme-light #tour-overlay .tour-cta-btn {
      background: rgba(59, 130, 246, 0.12);
      border-color: var(--Color/Accent/Primary);
      color: var(--tour-text-secondary);
    }
    
    .theme-light #tour-overlay .tour-cta-btn:hover {
      background: rgba(59, 130, 246, 0.18);
    }
    
    /* HUD big panel headings - tour style (highest priority, at end of CSS) */
    #hud-big-panel h1,
    #hud-big-panel h2,
    #hud-big-panel h3,
    #hud-big-panel h4,
    #hud-big-panel h5,
    #hud-big-panel h6,
    .hud-active #hud-big-panel h1,
    .hud-active #hud-big-panel h2,
    .hud-active #hud-big-panel h3,
    .hud-active #hud-big-panel h4,
    .hud-active #hud-big-panel h5,
    .hud-active #hud-big-panel h6,
    #hud-container #hud-big-panel h1,
    #hud-container #hud-big-panel h2,
    #hud-container #hud-big-panel h3,
    #hud-container #hud-big-panel h4,
    #hud-container #hud-big-panel h5,
    #hud-container #hud-big-panel h6,
    .hud-active #hud-container #hud-big-panel h1,
    .hud-active #hud-container #hud-big-panel h2,
    .hud-active #hud-container #hud-big-panel h3,
    .hud-active #hud-container #hud-big-panel h4,
    .hud-active #hud-container #hud-big-panel h5,
    .hud-active #hud-container #hud-big-panel h6 {
      font: 600 20px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
      white-space: normal !important;
    }
    /* Main heading (h2) - 10px margin bottom to paragraph (highest priority) */
    #hud-big-panel h2,
    .hud-active #hud-big-panel h2,
    #hud-container #hud-big-panel h2,
    .hud-active #hud-container #hud-big-panel h2 {
      margin: 0 0 10px 0 !important;
    }
    /* Subheadings (h3, h4) - smaller than main heading (highest priority) */
    #hud-big-panel h3,
    .hud-active #hud-big-panel h3,
    #hud-container #hud-big-panel h3,
    .hud-active #hud-container #hud-big-panel h3 {
      font: 600 18px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
      white-space: normal !important;
    }
    #hud-big-panel h4,
    .hud-active #hud-big-panel h4,
    #hud-container #hud-big-panel h4,
    .hud-active #hud-container #hud-big-panel h4 {
      font: 600 16px/1.3 ui-sans-serif, system-ui !important;
      color: var(--HUD/Text/Base) !important;
      margin: 0 0 0 0 !important;
      font-weight: 600 !important;
      white-space: normal !important;
    }
    /* Paragraph spacing: 20px between paragraphs (highest priority) */
    #hud-big-panel p,
    .hud-active #hud-big-panel p,
    #hud-container #hud-big-panel p,
    .hud-active #hud-container #hud-big-panel p {
      margin: 0 0 20px 0 !important;
      line-height: 1.5 !important;
    }
    #hud-big-panel p:last-child,
    .hud-active #hud-big-panel p:last-child,
    #hud-container #hud-big-panel p:last-child,
    .hud-active #hud-container #hud-big-panel p:last-child {
      margin-bottom: 0 !important;  /* Убрать отступ у последнего абзаца */
    }
    /* Remove spacing after subheadings - no margin for first paragraph after h3/h4 (highest priority) */
    #hud-big-panel h3 + p,
    #hud-big-panel h4 + p,
    .hud-active #hud-big-panel h3 + p,
    .hud-active #hud-big-panel h4 + p,
    #hud-container #hud-big-panel h3 + p,
    #hud-container #hud-big-panel h4 + p,
    .hud-active #hud-container #hud-big-panel h3 + p,
    .hud-active #hud-container #hud-big-panel h4 + p {
      margin-top: 0 !important;  /* Убрать отступ у первого абзаца после подзаголовка */
    }
  </style>
</div>

<!-- No-JS Fallback -->
<noscript>
  <div style="position: fixed; inset: 0; z-index: 9999; background: var(--Color/Dark/Background/Primary); color: var(--Color/Light/Text/Primary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; font-family: ui-sans-serif, system-ui, sans-serif;">
    <h1 style="font-size: 24px; font-weight: 600; margin: 0 0 16px 0; color: var(--Color/Light/Text/Secondary);">Интерактивные элементы требуют JavaScript</h1>
    <p style="font-size: 16px; line-height: 1.5; max-width: 600px; margin: 0 0 24px 0; color: var(--Color/Light/Text/Muted);">
      Этот сайт использует 3D-интерактивы и требует включения JavaScript для полноценной работы.
    </p>
    <p style="font-size: 16px; line-height: 1.5; max-width: 600px; margin: 0 0 24px 0;">
      Вы можете ознакомиться с материалами в статическом формате:
    </p>
    <a href="./Vladimir_Kostyal_Resume.pdf" target="_blank" style="display: inline-block; padding: 12px 24px; background: var(--Color/Accent/Primary); color: var(--Color/Light/Text/OnBrand); text-decoration: none; font-weight: 500; margin-bottom: 12px;">
      Скачать резюме (PDF)
    </a>
    <p style="font-size: 14px; color: var(--Color/Light/Text/Muted); margin-top: 24px;">
      Или свяжитесь напрямую: <a href="https://t.me/scrumux" target="_blank" style="color: var(--Color/Accent/Primary); text-decoration: underline;">Telegram</a>
    </p>
  </div>
</noscript>

<!-- Header -->
<header id="site-header">
  <div class="header-logo">
    <span class="name">Владимир Костял</span>
    <span class="tagline">проектирую UX архитектуру и интерфейсы для AI сервисов</span>
  </div>
  <div class="header-spacer"></div>
  <button class="header-btn" id="btn-demo">Демо</button>
  <button class="header-btn" id="btn-links">Ссылки</button>
  <button class="header-btn" id="btn-about">Автор</button>
  <div id="theme-toggle-container"></div>
</header>

<!-- Mode banner -->
<div id="mode-banner">Режим: Орбита (ESC — вернуться к пролистыванию)</div>

<!-- Mobile orbit mode toggle -->
<div id="mobile-orbit-toggle" style="display: none;">
  <button id="toggle-orbit-btn">
    <img id="toggle-orbit-icon" src="./camera_24dp_434343_FILL0_wght400_GRAD0_opsz24.svg" alt="Camera" loading="lazy" width="24" height="24" />
  </button>
</div>

<!-- Links panel -->
<div id="links-panel">
  <button class="close-btn" id="btn-links-close">✕</button>
  <div class="link-row"><a href="#" id="lnk-tg-chat" target="_blank">💬 Написать в Telegram</a></div>
  <div class="link-row"><a href="#" id="lnk-tg-community" target="_blank">👥 Перейти в сообщество</a></div>
  <div class="link-row"><a href="#" id="lnk-resume" target="_blank">📄 Резюме (PDF)</a></div>
  <div class="link-kicker">Все контакты открываются в новой вкладке.</div>
</div>

<!-- Canvas and labels -->
<div id="three-container"></div>
<div id="labels"></div>

<!-- HUD elements -->
<div id="overlay"></div>
<!-- HUD backdrop (similar to tour backdrop) -->
<div id="hud-backdrop" class="hidden"></div>

<div id="hud-object-icon"></div>
<!-- Wrap the HUD panels inside a container so they can be centred and stacked responsively -->
<div id="hud-container">
  <div id="hud-small-panel">
    <button data-index="0">Вариант 1</button>
    <button data-index="1">Вариант 2</button>
    <button data-index="2">Вариант 3</button>
          </div>
  <div id="hud-big-panel"></div>
        </div>

  <!-- Grid overlay (thin through-borders that form the HUD grid) -->
  <div id="grid-overlay" aria-hidden="true"></div>
  <!-- Background grid under HUD overlay -->
  <canvas id="grid-canvas-bg" aria-hidden="true"></canvas>
  <canvas id="grid-canvas" aria-hidden="true"></canvas>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
  }
}
</script>
<script>
  // ===== PHASE B.1: Compute base path for UX4AI (simplified) =====
  // Считаем, что index.html лежит в корне проекта UX4AI,
  // все модули и файлы подключаются ОТНОСИТЕЛЬНЫМИ путями от него.
  const base = '.';
  window.__UX4AI_BASE_PATH__ = base;
  console.log('[Bootstrap] UX4AI base path set to "." (relative root)');
  
  // ===== PHASE B: Set preloader iframe src with fixed relative path =====
  // Прелоадер всегда грузится из текущей папки рядом с index.html
  (function() {
    const preloaderFrame = document.getElementById('preloader-frame');
    if (preloaderFrame) {
      const preloaderPath = './ux4ai-preloader-loop-outline-noise.html';
      preloaderFrame.src = preloaderPath;
      console.log('[Bootstrap] Preloader path set:', preloaderFrame.src);
      
      preloaderFrame.addEventListener('error', (e) => {
        console.error('[Bootstrap] Preloader iframe failed to load:', preloaderPath);
        console.error('[Bootstrap] This may indicate that the file is missing next to index.html');
      }, { once: true });
    } else {
      console.warn('[Bootstrap] Preloader iframe element not found');
    }
  })();
</script>
<script type="module">
async function init() {
  try {
    
    console.log('[Bootstrap] Importing THREE via importmap...');
    const THREE = await import('three');
    console.log('✓ THREE imported');
    // NOTE: Preloader will be hidden after theme fully mounts (see below)
    
    // Make available globally for modules
    window.THREE = THREE;
    
    console.log('[Bootstrap] Importing modules...');
    // Use base path for all imports
    const base = window.__UX4AI_BASE_PATH__ || '';
    
    const { createEngine } = await import(`${base}/core/engine.js?v=38`);
    const { initThemeSwitcher, toggleTheme } = await import(`${base}/ui/themeSwitcher.js?v=38`);
    const { initHUD } = await import(`${base}/core/hud-manager.js?v=47`);
    const { initTheme, setEngine, getCurrentThemeId } = await import(`${base}/ui/theme-controller.js`);
    
    // ===== PHASE B: Expose theme functions globally for HUD =====
    // CRITICAL: All theme functions must be exposed BEFORE HUD initialization
    // This eliminates the need for dynamic imports in hud-manager.js
    if (typeof getCurrentThemeId === 'function') {
      window.getCurrentThemeId = getCurrentThemeId;
      console.log('[Bootstrap] window.getCurrentThemeId exposed:', typeof window.getCurrentThemeId);
    } else {
      console.error('[Bootstrap] getCurrentThemeId is not a function!');
    }
    
    // Initialize theme FIRST (before creating engine)
    // This applies CSS classes and ensures theme variables are available
    console.log('[Bootstrap] Initializing theme...');
    initTheme(); // Reads from localStorage/hash and applies theme
    
    // Force CSS recalculation to ensure theme variables are available
    document.documentElement.offsetHeight; // Force reflow
    
    console.log('[Bootstrap] Creating engine...');
    const engine = createEngine({
      canvasParent: document.getElementById('three-container'),
      labelsElement: document.getElementById('labels')
    });
    
    // Set engine reference in theme controller
    setEngine(engine);
    
    // Ensure engine scene background matches current theme immediately
    try {
      const { getSceneColors } = await import(`${base}/core/theme-colors.js`);
      const sceneColors = getSceneColors();
      if (engine.scene && engine.scene.background) {
        engine.scene.background = new THREE.Color(sceneColors.background);
      }
    } catch (e) {
      console.warn('[Bootstrap] Could not update scene background:', e);
    }
    
    // NOTE: Preloader will be hidden after theme fully mounts (see below)
    // Expose engine for grid overlay to query current scene state
    try { window._engine = engine; } catch(_) {}
    
    // Initialize theme switcher (mounts scene ONCE)
    console.log('[Bootstrap] Initializing theme switcher...');
    initThemeSwitcher(engine);
    
    // ===== PHASE B: Expose toggleTheme globally for HUD =====
    // CRITICAL: Must be set synchronously before HUD initialization
    // This eliminates the need for dynamic imports in hud-manager.js
    if (typeof toggleTheme === 'function') {
      window.toggleTheme = toggleTheme;
      console.log('[Bootstrap] window.toggleTheme exposed:', typeof window.toggleTheme);
      // Verify function is actually callable
      if (typeof window.toggleTheme !== 'function') {
        console.error('[Bootstrap] CRITICAL: window.toggleTheme was set but is not a function!');
      }
    } else {
      console.error('[Bootstrap] toggleTheme is not a function! Module may have failed to load.');
      console.error('[Bootstrap] toggleTheme type:', typeof toggleTheme);
      console.error('[Bootstrap] toggleTheme value:', toggleTheme);
    }
    console.log('[Bootstrap] All theme functions available:', {
      getCurrentThemeId: typeof window.getCurrentThemeId,
      toggleTheme: typeof window.toggleTheme
    });
    
    // NOTE: HUD will be initialized in engine.initNavigationAndHUD() after scene is mounted
    // This ensures HUD has access to nodes from the scene
    // We don't initialize HUD here to avoid double initialization
    console.log('[Bootstrap] HUD will be initialized after scene is mounted');
    
    // ===== ФАЗА B: Tour Restart Button - Bootstrap Creation =====
    // OWNER: Bootstrap (index.html) - ONLY responsible for creating #tour-restart-btn
    // RESPONSIBILITY:
    //   - Creates #tour-restart-btn ONCE
    //   - Attaches click/keydown handlers ONCE
    //   - NEVER touches #theme-toggle-btn or any other children of #theme-toggle-container
    //   - NEVER removes, recreates, or moves other elements
    // TOUR RESPONSIBILITY (separate):
    //   - Manages visibility (style.display) via showTour/hideTour functions
    //   - NEVER recreates or moves the button
    //   - NEVER touches #theme-toggle-btn (жёсткий контракт Фаза B)
    //
    // ФАЗА B: ЖЁСТКИЙ КОНТРАКТ
    // Единственный владелец #theme-toggle-btn — HUD (core/hud-manager.js).
    // Bootstrap НЕ может искать #theme-toggle-btn через getElementById/querySelector
    // Bootstrap НЕ может менять display/visibility/opacity/pointer-events напрямую
    // Bootstrap НЕ может перемещать или удалять кнопку
    // Bootstrap может ТОЛЬКО вызывать window.hud.ensureThemeButton() для стабилизации
    try {
      const container = document.getElementById('theme-toggle-container') || document.getElementById('site-header');
      if (container) {
        // PHASE TT1: Check if button already exists (idempotent creation)
        let btn = document.getElementById('tour-restart-btn');
        if (!btn) {
          // PHASE TT1: Create button ONCE - this is the single source of creation
          // CRITICAL: Only creates tour-restart-btn, never touches other children
          btn = document.createElement('button');
          btn.id = 'tour-restart-btn';
          btn.className = 'header-btn';
          btn.setAttribute('aria-label', 'Перезапустить тур');
          btn.title = 'Перезапустить тур';
          btn.tabIndex = 0;
          btn.innerHTML = '<img src="./replay_24dp_434343_FILL0_wght400_GRAD0_opsz24.svg" alt="Restart tour" width="24" height="24" loading="lazy" aria-hidden="true" />';
          btn.style.display = 'inline-flex';
          
          // PHASE TT1: Append ONLY tour-restart-btn to container
          // CRITICAL: Does NOT remove, clear, or touch other children (e.g., theme-toggle-btn)
          container.appendChild(btn);
          console.log('[Bootstrap] Tour restart button created (PHASE TT1: isolated creation)');
        } else {
          // PHASE TT1: Button already exists - just ensure it's visible
          // CRITICAL: Does NOT touch other children of container
          btn.style.display = 'inline-flex';
        }
        
        // PHASE TT1: Set initial visibility (tour is closed by default)
        // CRITICAL: Only modifies tour-restart-btn, never touches theme-toggle-btn
        btn.style.display = 'inline-flex';
        
        // Analytics: view when in viewport (not self-healing, just analytics)
        try {
          const io = new IntersectionObserver((entries)=>{
            entries.forEach(en=>{ if (en.isIntersecting) { console.log('analytics: tour_restart_icon_view'); io.disconnect(); } });
          });
          io.observe(btn);
        } catch {}
        
        // ===== PHASE TT3: Tour Restart Button Click Handler - Absolutely Clean =====
        // OWNER: Bootstrap (index.html) - ONLY handles tour restart button clicks
        // RESPONSIBILITY:
        //   - Ignores non-relevant keys (only Enter/Space)
        //   - Checks if tour overlay is already open (prevents double-click)
        //   - Calls window.tour_reset() ONCE
        //   - Prevents default and stops propagation
        // CRITICAL INVARIANTS:
        //   - NO imports of themeSwitcher/theme-controller
        //   - NO access to #theme-toggle-btn
        //   - NO logic to "fix header/buttons"
        //   - NO side effects on theme, HUD, or any other elements
        const onActivate = (e) => {
          // PHASE TT3: Ignore non-relevant keys (only Enter and Space activate)
          if (e.type === 'keydown' && !(e.key === 'Enter' || e.key === ' ')) {
            return;
          }
          
          // PHASE TT3: Check if tour overlay is already open (prevent double-click issues)
          // CRITICAL: Only checks tour-overlay state, does NOT touch other elements
          const overlayActive = !!(document.getElementById('tour-overlay') && 
                                   !document.getElementById('tour-overlay').classList.contains('hidden'));
          if (overlayActive) {
            e.preventDefault();
            e.stopPropagation();
            return;
          }
          
          // PHASE TT3: Call window.tour_reset() ONCE - tour will manage button visibility
          // CRITICAL: Does NOT switch theme, does NOT touch theme-toggle-btn, does NOT touch HUD
          // CRITICAL: No imports, no side effects, only tour restart
          if (typeof window.tour_reset === 'function') {
            window.tour_reset();
          } else {
            console.error('[Tour] window.tour_reset is not available, tour cannot be restarted');
          }
          
          // PHASE TT3: Prevent default and stop propagation for complete isolation
          e.preventDefault();
          e.stopPropagation();
        };
        
        // PHASE TT3: Attach ONLY these two event listeners - no others
        // CRITICAL: No additional listeners that could trigger theme or HUD logic
        btn.addEventListener('click', onActivate);
        btn.addEventListener('keydown', onActivate);
        
        // PHASE TT1: No self-healing, no MutationObserver, no hashchange/storage listeners
        // Button is created once in bootstrap, tour manages visibility via showTour/hideTour
        // CRITICAL: Bootstrap never touches theme-toggle-btn or any other children
      }
    } catch (e) {
      console.error('[Bootstrap] Failed to create tour restart button:', e);
    }
    
    // Listen for theme mounted event
    // HUD is initialized early, but we need to update it with nodes after scene is mounted
    engine.on('themeMounted', ({ themeId }) => {
      console.log('[Bootstrap] Theme mounted event received:', themeId);
      
      // Update HUD with nodes from mounted scene
      try {
        const plugin = engine.currentPlugin || window._calmPlugin;
        if (plugin && plugin.nodes) {
          console.log('[Bootstrap] Updating HUD with', plugin.nodes.length, 'nodes');
          // HUD should get nodes from engine, but we can also update it here
          // The nodes are already passed via initNavigationAndHUD, but let's ensure HUD has access
          if (typeof window._hud === 'object' && window._hud) {
            // HUD already has nodes from initNavigationAndHUD
            console.log('[Bootstrap] HUD already has nodes');
          }
        }
      } catch (e) {
        console.warn('[Bootstrap] Could not update HUD with nodes:', e);
      }
      
      // ===== ФАЗА B: Bootstrap НЕ манипулирует кнопкой темы напрямую =====
      // КОНТРАКТ: Bootstrap НЕ имеет права изменять #theme-toggle-btn напрямую
      // RESPONSIBILITY:
      //   - Bootstrap может только вызывать HUD API для стабилизации кнопки
      //   - НЕ может менять display/visibility/opacity/pointer-events напрямую
      //   - НЕ может искать #theme-toggle-btn через getElementById/querySelector
      //   - НЕ может перемещать или удалять кнопку
      // CRITICAL INVARIANT: Единственный владелец #theme-toggle-btn — HUD Manager
      // ФАЗА B: Используем HUD API вместо прямых манипуляций
      try {
        if (window.hud && typeof window.hud.ensureThemeButton === 'function') {
          window.hud.ensureThemeButton();
          console.log('[Bootstrap] Theme button stabilized via HUD API after theme mount (ФАЗА B: контракт)');
        } else {
          console.warn('[Bootstrap] HUD API not available, cannot stabilize theme button');
        }
      } catch (e) {
        console.error('[Bootstrap] Error calling HUD API for theme button:', e);
      }
      
      // Hide preloader when the first theme fully mounts
      try {
        const pre = document.getElementById('preloader-overlay');
        if (pre) setTimeout(() => pre.classList.add('hidden'), 150);
      } catch {}
    });
    
    console.log('[Bootstrap] ✅ Ready!');
    // Safety: hide preloader on load even if themeMounted didn't fire (fallback)
    window.addEventListener('load', () => {
      try {
        const pre = document.getElementById('preloader-overlay');
        if (pre) pre.classList.add('hidden');
      } catch {}
    }, { once: true });
    // Absolute safety: hide regardless after a maximum wait
    setTimeout(() => {
      try { const pre = document.getElementById('preloader-overlay'); if (pre) pre.classList.add('hidden'); } catch {}
    }, 8000);

    // ===== Guided Tour (PHASE 3: Using tour module) =====
    (async function initGuidedTour(){
      try {
        // Import tour module
        const base = window.__UX4AI_BASE_PATH__ || '';
        const { initTour, TOUR_STEPS } = await import(`${base}/core/tour.js?v=1`);
        
        // Parse URL parameters
      const params = new URLSearchParams(location.search);
      const tourOff = params.get('tour') === 'off';
      if (params.get('tour') === 'reset') {
              try { 
                localStorage.removeItem('tour_done'); 
                localStorage.removeItem('tour_step');
          } catch {}
        }
        const done = (typeof localStorage !== 'undefined') ? localStorage.getItem('tour_done') : null;
        const tourDone = done === '1';
        
        // Initialize tour module
        const tour = initTour({ tourOff, tourDone });
        
        if (!tour) {
          console.error('[Tour] Failed to initialize tour module');
              return;
            }
        
        // Export tour API to window - CRITICAL: Must be set before any tour button clicks
        window.tour_reset = tour.tour_reset;
        window.showTour = tour.showTour;
        window.hideTour = tour.hideTour;
        window.setTourStep = tour.setStep;
        window.startTour = tour.startTour;
        console.log('[Tour] Tour API exported to window:', {
          hasTourReset: typeof window.tour_reset === 'function',
          hasStartTour: typeof window.startTour === 'function'
        });
        
        // Export steps for fallback (if needed)
        try {
          window.tourSteps = TOUR_STEPS;
        } catch (e) {
          console.warn('[Tour] Could not export tourSteps:', e);
        }
        
        // Setup close button handler
      try { 
        const closeBtn = document.getElementById('tour-close'); 
        if (closeBtn) { 
          let closeBtnProcessing = false;
          const isMobileCloseBtn = window.innerWidth <= 767;
          const handleCloseBtnAction = (e) => {
            if (closeBtnProcessing) {
              e.preventDefault();
              e.stopPropagation();
              return;
            }
            closeBtnProcessing = true;
            e.preventDefault();
            e.stopPropagation();
              tour.dismissTour();
            setTimeout(() => { closeBtnProcessing = false; }, 50);
          };
          if (isMobileCloseBtn) {
            closeBtn.addEventListener('touchstart', handleCloseBtnAction, { passive: false });
          } else {
            closeBtn.addEventListener('click', handleCloseBtnAction);
          }
            closeBtn.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault(); 
                tour.dismissTour();
            } 
          }); 
        } 
        } catch (e) {
          console.warn('[Tour] Could not setup close button:', e);
        }
        
        // Schedule display as soon as preloader hides
        const tryShow = () => {
          const preHidden = !document.getElementById('preloader-overlay') || document.getElementById('preloader-overlay').classList.contains('hidden');
          if (!preHidden) {
            setTimeout(tryShow, 120);
            return;
          }
          const step = Number((typeof localStorage !== 'undefined' && localStorage.getItem('tour_step')) || '1') || 1;
          console.log('[Tour] Attempting to start tour from step:', step);
          const started = tour.startTour(step);
          if (!started) {
            console.error('[Tour] Failed to start tour on page load. Check console for detailed error messages from tour module.');
          } else {
            console.log('[Tour] Tour started successfully from step:', step);
          }
        };
      tryShow();
        
        console.log('[Tour] Tour module initialized successfully');
      } catch (e) {
        console.error('[Tour] Failed to initialize tour module:', e);
      }
    })();

    // Ensure any prior custom cursor element is removed
    try { const old = document.getElementById('custom-cursor'); if (old) old.remove(); } catch(_) {}

    // -------- HUD Grid (through-borders) ----------
    // Renders 1px lines across the whole viewport at the edges of HUD panels.
    const GRID_COLOR = 'rgba(120, 220, 255, 0.25)';
    const overlay = document.getElementById('grid-overlay');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.pointerEvents = 'none';
    overlay.style.zIndex = '850'; // above scene, below labels/HUD
    // Disable DOM-line overlay; we will draw via canvas for reliable animation
    overlay.style.display = 'none';

    // Canvas grid overlay (reliable, animated in sync with core pulse)
    const canvas = document.getElementById('grid-canvas');
    const canvasBg = document.getElementById('grid-canvas-bg');
    canvas.style.position = 'fixed';
    canvas.style.inset = '0';
    canvas.style.pointerEvents = 'none';
    canvas.style.zIndex = '850';
    if (canvasBg) {
      canvasBg.style.position = 'fixed';
      canvasBg.style.inset = '0';
      canvasBg.style.pointerEvents = 'none';
      canvasBg.style.zIndex = '890';
    }
    // Grid only active in HUD mode or during tour
    function isGridActive() {
      const root = document.documentElement;
      const tourOverlay = document.getElementById('tour-overlay');
      const tourActive = tourOverlay && !tourOverlay.classList.contains('hidden');
      return root.classList.contains('hud-active') || root.classList.contains('links-active') || tourActive;
    }
    var GRID_SIMPLE = false; // bind to Calm wireframe
    let ctx = canvas.getContext('2d');
    let ctxBg = canvasBg ? canvasBg.getContext('2d') : null;
    // Flicker state synced to Calm intensity
    var _flicker = {
      lastI: 0,
      peaks: [], // {t0, dur, amp}
      activeUntil: 0,
      seed: Math.random()*1000
    };

    const LINE_THICK = 1; // px
    const targetsSelectors = [
      '#site-header',
      '#links-panel',
      '#hud-container',
      '#hud-small-panel',
      '#hud-big-panel',
      '#mobile-orbit-toggle'
    ];

    function clearLines() {
      while (overlay.firstChild) overlay.removeChild(overlay.firstChild);
    }

    function addLine(x, y, w, h) {
      const dpr = window.devicePixelRatio || 1;
      const el = document.createElement('div');
      el.style.position = 'absolute';
      el.style.left = Math.floor(x) + 'px';
      el.style.top = Math.floor(y) + 'px';
      el.style.width = w + 'px';
      el.style.height = h + 'px';
      el.className = 'grid-line ' + (h === 1 ? 'h' : 'v');
      // randomize dash/gap/phase so lines are desynchronized
      const rand = (min, max) => Math.random() * (max - min) + min;
      const dash = Math.round(rand(6, 14));
      const gap = Math.round(rand(6, 12));
      const phase = Math.round(rand(0, dash + gap));
      el.style.setProperty('--dash', dash + 'px');
      el.style.setProperty('--gap', gap + 'px');
      el.style.setProperty('--phase', phase + 'px');
      // crisp lines on fractional edges and high-DPI
      const fx = x - Math.floor(x);
      const fy = y - Math.floor(y);
      let tx = 0, ty = 0;
      if (Math.abs(fx - 0.5) < 0.26) tx = 0.5; // snap ~*.5px
      if (Math.abs(fy - 0.5) < 0.26) ty = 0.5;
      // On odd DPR physically shift lines by half pixel to sit on device pixel grid
      if (dpr % 2 !== 0) {
        if (w === 1) tx = tx || 0.5;
        if (h === 1) ty = ty || 0.5;
      }
      if (tx || ty) el.style.transform = `translate(${tx}px, ${ty}px)`;
      overlay.appendChild(el);
    }

    // Cache arrays for canvas drawing (declared early so buildGrid can fill them)
    let cachedXs = [], cachedYs = [], lineSeeds = new Map();
    let lineDirsX = [], lineDirsY = [];
    let prevFlashActive = false;
    // (grid cursor crosshair disabled)

    function buildGrid() {
      if (!isGridActive()) return;
      clearLines();
      const rects = [];
      // During tour, build grid for entire viewport (visible through overlays)
      const tourOverlay = document.getElementById('tour-overlay');
      const tourActive = tourOverlay && !tourOverlay.classList.contains('hidden');
      if (tourActive) {
        // For tour, create a full-screen grid with 24px spacing (like HUD mode)
        // This will be visible through the transparent card
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const GRID_STEP = 24;
        // Generate grid lines across entire viewport
        const gridXs = new Set();
        const gridYs = new Set();
        for (let x = 0; x <= vw; x += GRID_STEP) {
          gridXs.add(x);
        }
        for (let y = 0; y <= vh; y += GRID_STEP) {
          gridYs.add(y);
        }
        // Store for drawing (will be used in drawCanvasGrid)
        cachedXs = Array.from(gridXs).sort((a,b)=>a-b);
        cachedYs = Array.from(gridYs).sort((a,b)=>a-b);
        // Assign random seeds for flicker
        lineSeeds = new Map();
        cachedXs.forEach((x,i)=> lineSeeds.set('x'+i, Math.random()));
        cachedYs.forEach((y,i)=> lineSeeds.set('y'+i, Math.random()));
        return; // Skip normal grid building for tour
      } else {
        // Normal HUD mode: build grid around specific elements
        targetsSelectors.forEach(sel => {
          const el = document.querySelector(sel);
          if (!el) return;
          const r = el.getBoundingClientRect();
          if (r.width > 0 && r.height > 0) rects.push(r);
          // также учесть прямых детей (строки/карточки внутри малого HUD)
          if (el.id === 'hud-small-panel') {
            el.childNodes.forEach(n => {
              if (n.nodeType !== 1) return;
              const rr = n.getBoundingClientRect();
              if (rr.width > 0 && rr.height > 0) rects.push(rr);
            });
          }
        });
      }
      if (rects.length === 0) return;

      // Собираем уникальные X/Y краёв
      const xs = new Set();
      const ys = new Set();
      rects.forEach(r => {
        const left = r.left;
        const right = r.right - LINE_THICK;   // align to the visible right border
        const top = r.top;
        const bottom = r.bottom - LINE_THICK; // align to the visible bottom border
        xs.add(left);
        xs.add(right);
        ys.add(top);
        ys.add(bottom);
      });

      const vw = window.innerWidth;
      const vh = window.innerHeight;
      // Compute canvas size with device pixel ratio for crisp 1px strokes
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(vw * dpr);
      canvas.height = Math.floor(vh * dpr);
      canvas.style.width = vw + 'px';
      canvas.style.height = vh + 'px';
      ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Cache edges for canvas drawing
      // Exclude the area next to the scrollbar (avoid rightmost vertical line)
      const rightGutter = 18; // ~scrollbar width on Win
      cachedXs = Array.from(xs).sort((a,b)=>a-b).filter(x => x > 0.5 && x < (vw - rightGutter));
      cachedYs = Array.from(ys).sort((a,b)=>a-b).filter(y => y > 0.5 && y < vh - 0.5);
      // assign random dash settings per line for desync
      lineSeeds = new Map();
      cachedXs.forEach((x,i)=> lineSeeds.set('x'+i, Math.random()));
      cachedYs.forEach((y,i)=> lineSeeds.set('y'+i, Math.random()));
      // initialize directions (+1/-1) per line
      lineDirsX = cachedXs.map(()=> (Math.random()<0.5? -1: 1));
      lineDirsY = cachedYs.map(()=> (Math.random()<0.5? -1: 1));
      drawCanvasGrid(0);
    }

    // Рисуем после монтирования темы (несколько тактов, чтобы схватить поздние размеры)
    function scheduleBuildBurst() {
      buildGrid();
      requestAnimationFrame(buildGrid);
      setTimeout(buildGrid, 50);
      setTimeout(buildGrid, 150);
    }
    // Mobile HUD: keep 12px gap below site header
    function updateMobileHudTop(){
      try {
        const isMobile = window.innerWidth <= 479;
        const header = document.getElementById('site-header');
        const hudContainer = document.getElementById('hud-container');
        if (!header || !hudContainer) return;
        if (isMobile) {
          const h = Math.round(header.getBoundingClientRect().height || 0);
          hudContainer.style.setProperty('top', (h + 12) + 'px', 'important');
        } else {
          // restore desktop top from CSS
          hudContainer.style.removeProperty('top');
        }
      } catch {}
    }
    engine.on('themeMounted', () => {
      scheduleBuildBurst();
      updateMobileHudTop();
    });
    // Debounced resize handler for mobile HUD positioning
    let resizeHudTimeout = null;
    const debouncedUpdateMobileHudTop = () => {
      clearTimeout(resizeHudTimeout);
      resizeHudTimeout = setTimeout(() => {
        updateMobileHudTop();
      }, 150);
    };
    try { window.addEventListener('resize', debouncedUpdateMobileHudTop, { passive: true }); } catch {}

    // Initial draw at startup (before any theme mounts) so Calm scene shows lines
    scheduleBuildBurst();

    // --- Canvas drawing loop ---
    // Listen for Calm scene pulse events
    var pulseHueDeg = 200; var pulseUntilMs = 0; var forceStepUntilMs = 0;
    var pulseIntensity = null; // 0..1 from Calm
    // Synthetic flicker (working baseline): fast sine + noisy threshold, no scheduler
    var flashLevel = 0.12; // current alpha
    var lastMs = (typeof performance !== 'undefined') ? performance.now() : Date.now();
    var noiseSeed = Math.random()*1000;
    try {
      window.addEventListener('calmPulse', (e) => {
        const now = (typeof performance !== 'undefined') ? performance.now() : Date.now();
        const detail = (e && e.detail) || {};
        const hueDeg = (typeof detail.hueDeg === 'number') ? detail.hueDeg : 200;
        const inten = (typeof detail.intensity === 'number') ? Math.max(0, Math.min(1, detail.intensity)) : null;
        pulseHueDeg = hueDeg;
        pulseIntensity = inten;
        pulseUntilMs = now + 320; // longer 320ms flash for visibility
        forceStepUntilMs = pulseUntilMs;
      });
    } catch(_) {}
    function pulseColor(t){
      // Prefer Calm wireframe state if available
      let sceneHue = null; let sceneFlash = null; let sceneRgb = null; let sceneIntensity = null; let hasWF = false;
      let syntheticFlashActive = null;
      try {
        // Highest priority: direct Calm getter if present
        let wf = null;
        if (typeof window.__getCalmWireframeState === 'function') {
          wf = window.__getCalmWireframeState();
        } else if (window._calmPlugin && typeof window._calmPlugin.getWireframeState === 'function') {
          wf = window._calmPlugin.getWireframeState();
        } else if (window._engine && window._engine.currentPlugin && typeof window._engine.currentPlugin.getWireframeState === 'function') {
          wf = window._engine.currentPlugin.getWireframeState();
        }
        if (wf) {
          hasWF = true;
          if (typeof wf.hueDeg === 'number') sceneHue = wf.hueDeg;
          if (typeof wf.flash === 'number') sceneFlash = wf.flash;
          if (wf.rgb && typeof wf.rgb.r === 'number') sceneRgb = wf.rgb;
          if (typeof wf.intensity === 'number') sceneIntensity = Math.max(0, Math.min(1, wf.intensity));
        }
        // Fallback to Calm globals if plugin state is unavailable
        if (!hasWF && typeof window !== 'undefined') {
          if (typeof window._coreHueDeg === 'number') sceneHue = window._coreHueDeg;
          if (typeof window._corePulse === 'number') sceneIntensity = Math.max(0, Math.min(1, window._corePulse));
          if (typeof window._corePulseStep === 'number') sceneFlash = window._corePulseStep;
        }
        // Always read from Three.js scene by object name (authoritative if present)
        {
          const eng = window._engine;
          const obj = eng && eng.scene && typeof eng.scene.getObjectByName === 'function'
            ? eng.scene.getObjectByName('CalmCoreWire')
            : null;
          if (obj && obj.material) {
            const m = obj.material;
            if (typeof m.opacity === 'number') sceneIntensity = Math.max(0, Math.min(1, m.opacity));
            if (m.color) {
              const c = m.color;
              const max = Math.max(c.r, c.g, c.b), min = Math.min(c.r, c.g, c.b);
              let h = 200; const d = max - min;
              if (d > 1e-5) {
                if (max === c.r) h = ((c.g - c.b) / d) % 6;
                else if (max === c.g) h = (c.b - c.r) / d + 2;
                else h = (c.r - c.g) / d + 4;
                h *= 60; if (h < 0) h += 360;
              }
              sceneHue = h;
              sceneRgb = { r: Math.round(c.r*255), g: Math.round(c.g*255), b: Math.round(c.b*255) };
            }
          }
        }
      } catch(_) {}

      // If Calm is not providing state, synthesize it using the same style as Calm core
      const synthNeeded = !hasWF;
      if (synthNeeded) {
        // Synthetic color base (Calm core blue range)
        const tsec = t;
        const phase = 0.5 + 0.5*Math.sin(tsec * 0.60 * 2.0); // warpSpeed ~0.60
        const cO = { r: 0x58/255, g: 0xb7/255, b: 0xff/255 };
        const cI = { r: 0xa5/255, g: 0xf0/255, b: 0xff/255 };
        let baseR = (cO.r + (cI.r - cO.r) * phase) * 255;
        let baseG = (cO.g + (cI.g - cO.g) * phase) * 255;
        let baseB = (cO.b + (cI.b - cO.b) * phase) * 255;

        const nowMs = (typeof performance !== 'undefined') ? performance.now() : Date.now();
        const dt = Math.max(0, (nowMs - lastMs) / 1000);
        lastMs = nowMs;
        // Non-uniform threshold with noise; irregular but no scheduler
        const n = Math.sin(tsec*0.73 + noiseSeed) * 0.08; // slow noise
        const fast = Math.sin(tsec * 6.0 + Math.sin(tsec*1.5+noiseSeed)*0.33);
        const thr = 0.78 + n; // 0.70..0.86 jitter
        const isFlash = fast > thr;
        // Warm flash palette (yellow/orange/red blend)
        const warmMix = 0.5 + 0.5*Math.sin(tsec*3.1 + noiseSeed);
        const warmR = (0xff*(1-warmMix) + 0xff*warmMix);
        const warmG = (0xd2*(1-warmMix) + 0x4d*warmMix);
        const warmB = (0x4d*(1-warmMix) + 0x4d*warmMix);
        sceneRgb = isFlash
          ? { r: Math.round(warmR), g: Math.round(warmG), b: Math.round(warmB) }
          : { r: Math.round(baseR), g: Math.round(baseG), b: Math.round(baseB) };
        // Sharp rise/decay to targets
        const target = isFlash ? 0.28 : 0.10;
        const k = isFlash ? 22.0 : 12.0;
        flashLevel += (target - flashLevel) * (1 - Math.exp(-k*dt));
        const micro = Math.sin(tsec*37 + noiseSeed*2.3) * 0.012;
        sceneFlash = flashLevel + micro;
        syntheticFlashActive = isFlash;
        // Do not return here; continue to compute stroke below
      }

      // Visibility: if calmPulse window is active and carries intensity, use it strictly
      const now = (typeof performance !== 'undefined') ? performance.now() : Date.now();
      if (now < (pulseUntilMs||0) && typeof pulseIntensity === 'number') {
        // Step-like flash: no tails, slightly higher base
        const a = 0.16 + 0.22 * Math.max(0, Math.min(1, pulseIntensity));
        const hue = pulseHueDeg || 200;
        // Convert hue to RGB
        const H = ((hue % 360) + 360) % 360, S = 0.90, L = 0.70;
        const C = (1-Math.abs(2*L-1))*S; const X = C*(1-Math.abs(((H/60)%2)-1)); const m=L-C/2;
        let r1=0,g1=0,b1=0; const hSeg=Math.floor(H/60);
        if (hSeg===0){r1=C;g1=X;b1=0;} else if (hSeg===1){r1=X;g1=C;b1=0;} else if (hSeg===2){r1=0;g1=C;b1=X;} else if (hSeg===3){r1=0;g1=X;b1=C;} else if (hSeg===4){r1=X;g1=0;b1=C;} else {r1=C;g1=0;b1=X;}
        const rr = Math.round((r1+m)*255), gg = Math.round((g1+m)*255), bb = Math.round((b1+m)*255);
        return { stroke: `rgba(${rr},${gg},${bb},${a.toFixed(3)})`, p: 0, flashActive: true, alpha: a, hue: hue, intensity: pulseIntensity };
      }

      // Visibility: if we have sceneFlash as numeric alpha, use it; else step-only baseline
      let step = (typeof window !== 'undefined' && typeof window._corePulseStep === 'number') ? window._corePulseStep : null;
      let alpha;
      if (typeof sceneIntensity === 'number') {
        // Baseline strictly tied to Calm intensity (no randoms) — slightly higher base
        alpha = 0.22 + 0.16 * sceneIntensity;
      } else {
        if (sceneFlash != null) step = sceneFlash;
        alpha = (step === 0 || step === 1) ? (step === 1 ? 0.65 : 0.24) : 0.24;
      }

      // Stroke color
      const computedFlashActive = (syntheticFlashActive !== null) ? syntheticFlashActive : (!!step);
      if (sceneRgb) {
        const { r, g, b } = sceneRgb;
        return { stroke: `rgba(${r},${g},${b},${alpha.toFixed(3)})`, p: 0, flashActive: computedFlashActive, alpha, hue: sceneHue, intensity: sceneIntensity };
      }

      // Fallback to hue
      const baseHue = (sceneHue != null) ? sceneHue : 200;
      const H = ((baseHue % 360) + 360) % 360, S = 0.90, L = 0.70;
      const C = (1-Math.abs(2*L-1))*S; const X = C*(1-Math.abs(((H/60)%2)-1)); const m=L-C/2;
      let r1=0,g1=0,b1=0; const hSeg=Math.floor(H/60);
      if (hSeg===0){r1=C;g1=X;b1=0;} else if (hSeg===1){r1=X;g1=C;b1=0;} else if (hSeg===2){r1=0;g1=C;b1=X;} else if (hSeg===3){r1=0;g1=X;b1=C;} else if (hSeg===4){r1=X;g1=0;b1=C;} else {r1=C;g1=0;b1=X;}
      const rr = Math.round((r1+m)*255), gg = Math.round((g1+m)*255), bb = Math.round((b1+m)*255);
      return { stroke: `rgba(${rr},${gg},${bb},${alpha.toFixed(3)})`, p: 0, flashActive: computedFlashActive, alpha, hue: baseHue, intensity: sceneIntensity };
    }
    function drawCanvasGrid(t){
      try {
        if (!ctx) return;
        const vw = window.innerWidth, vh = window.innerHeight;
        // Ensure canvas matches viewport even when HUD is inactive (for crosshair)
        const dpr = window.devicePixelRatio || 1;
        const needResize = canvas.width !== Math.floor(vw * dpr) || canvas.height !== Math.floor(vh * dpr);
        if (needResize) {
          canvas.width = Math.floor(vw * dpr);
          canvas.height = Math.floor(vh * dpr);
          canvas.style.width = vw + 'px';
          canvas.style.height = vh + 'px';
          ctx = canvas.getContext('2d');
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        // Sync background canvas size
        if (canvasBg && ctxBg) {
          const needResizeBg = canvasBg.width !== Math.floor(vw * dpr) || canvasBg.height !== Math.floor(vh * dpr);
          if (needResizeBg) {
            canvasBg.width = Math.floor(vw * dpr);
            canvasBg.height = Math.floor(vh * dpr);
            canvasBg.style.width = vw + 'px';
            canvasBg.style.height = vh + 'px';
            ctxBg = canvasBg.getContext('2d');
            ctxBg.setTransform(dpr, 0, 0, dpr, 0, 0);
          }
        }
        ctx.clearRect(0,0,vw,vh);
        const pc = pulseColor(t/1000);
        const nowFlash = !!pc.flashActive;
        prevFlashActive = nowFlash;
        const hudOrLinks = isGridActive();
        const linksActive = document.documentElement.classList.contains('links-active');
        const hudActiveFlag = document.documentElement.classList.contains('hud-active');
        const tourOverlayEl = document.getElementById('tour-overlay');
        const tourActive = tourOverlayEl && !tourOverlayEl.classList.contains('hidden');
        const hudOnly = hudActiveFlag && !linksActive && !tourActive;
        // Base border color #243041 with reduced opacity
        const baseBorderColor = 'rgba(36,48,65,0.35)'; // reduced visibility
        // In HUD mode reduce flash visibility from 0.27 to 0.18
        const flashColor = hudOnly ? 'rgba(91,156,255,0.18)' : 'rgba(91,156,255,0.27)';
        ctx.lineWidth = 1;
        if (hudOrLinks) {
          // Draw grid lines only in HUD/Links mode
          // Solid lines (no dash) with very subtle color flicker during flash (all lines)
          cachedXs.forEach((x,i)=>{
            const seed = lineSeeds.get('x'+i) || 0.5;
            let lineColor = baseBorderColor;
            if (nowFlash) {
              // Very subtle flicker - very slow and barely noticeable
              const freq = 12; // much slower frequency
              const duty = 0.15; // shorter flash duration
              const ph = (t*freq + seed*3) % 1;
              const strobeOn = ph < duty;
              lineColor = strobeOn ? flashColor : baseBorderColor;
            }
            ctx.strokeStyle = lineColor;
            ctx.setLineDash([]); // solid line
            ctx.beginPath();
            // half-pixel align for crispness
            ctx.moveTo(Math.round(x)+0.5, 0);
            ctx.lineTo(Math.round(x)+0.5, vh);
            ctx.stroke();
          });
          cachedYs.forEach((y,i)=>{
            const seed = lineSeeds.get('y'+i) || 0.5;
            let lineColor = baseBorderColor;
            if (nowFlash) {
              // Very subtle flicker - very slow and barely noticeable
              const freq = 12; // much slower frequency
              const duty = 0.15; // shorter flash duration
              const ph = (t*freq + seed*3.7) % 1; // slightly different seed
              const strobeOn = ph < duty;
              lineColor = strobeOn ? flashColor : baseBorderColor;
            }
            ctx.strokeStyle = lineColor;
            ctx.setLineDash([]); // solid line
            ctx.beginPath();
            ctx.moveTo(0, Math.round(y)+0.5);
            ctx.lineTo(vw, Math.round(y)+0.5);
            ctx.stroke();
          });
        }
        // Background grid under HUD overlay: full-screen grid like tour
        if (canvasBg && ctxBg) {
          ctxBg.clearRect(0,0,vw,vh);
          const isMobile = window.innerWidth <= 767;
          if (hudOnly || linksActive || tourActive || (isMobile && (hudActiveFlag || linksActive))) {
            // Base opacity same; flash depends on mode (tour brighter)
            const baseBorderColor = 'rgba(36,48,65,0.35)';
            const flashColor = tourActive ? 'rgba(91,156,255,0.27)' : 'rgba(91,156,255,0.18)';
            const step = 24;
            // subtle flicker synced with tour logic
            const freq = 12;
            const duty = 0.15;
            const doFlicker = nowFlash;
            // Vertical lines
            let i = 0;
            for (let x=0; x<=vw; x+=step, i++) {
              let color = baseBorderColor;
              if (doFlicker) {
                const seed = (i*0.173)%1; // deterministic seed per line
                const ph = (t*freq + seed*3) % 1;
                const strobeOn = ph < duty;
                color = strobeOn ? flashColor : baseBorderColor;
              }
              ctxBg.strokeStyle = color;
              ctxBg.setLineDash([]);
              ctxBg.beginPath();
              ctxBg.moveTo(Math.round(x)+0.5, 0);
              ctxBg.lineTo(Math.round(x)+0.5, vh);
              ctxBg.stroke();
            }
            // Horizontal lines
            i = 0;
            for (let y=0; y<=vh; y+=step, i++) {
              let color = baseBorderColor;
              if (doFlicker) {
                const seed = (i*0.237)%1;
                const ph = (t*freq + seed*3.7) % 1;
                const strobeOn = ph < duty;
                color = strobeOn ? flashColor : baseBorderColor;
              }
              ctxBg.strokeStyle = color;
              ctxBg.setLineDash([]);
              ctxBg.beginPath();
              ctxBg.moveTo(0, Math.round(y)+0.5);
              ctxBg.lineTo(vw, Math.round(y)+0.5);
              ctxBg.stroke();
            }
          }
        }

        // (tour grid canvas removed)
        // --- Cursor crosshair (subtle) ---
        // Fade crosshair when idle
        // (grid cursor crosshair removed)
        // Debug HUD removed per request
      } catch (_) { /* swallow to keep app alive */ }
      requestAnimationFrame(drawCanvasGrid);
    }

    // Start the draw loop on startup (even outside HUD)
    try { requestAnimationFrame(drawCanvasGrid); } catch(_) {}

    // Перестраиваем на resize
    let gridTimer;
    window.addEventListener('resize', () => {
      clearTimeout(gridTimer);
      gridTimer = setTimeout(buildGrid, 100);
    });

    // Отслеживаем изменения layout HUD (display/классы/inline-стили)
    // Debounce для мобильных устройств для улучшения производительности
    let gridBuildTimeout = null;
    const debouncedBuildGrid = () => {
      clearTimeout(gridBuildTimeout);
      const isMobile = window.innerWidth <= 767;
      const delay = isMobile ? 100 : 0; // Задержка на мобильных
      gridBuildTimeout = setTimeout(() => {
        buildGrid();
      }, delay);
    };
    const moTargets = ['#site-header', '#links-panel', '#hud-container', '#hud-small-panel', '#hud-big-panel', '#mobile-orbit-toggle']
      .map(sel => document.querySelector(sel)).filter(Boolean);
    if (moTargets.length) {
      const mo = new MutationObserver(debouncedBuildGrid);
      moTargets.forEach(t => mo.observe(t, { attributes: true, attributeFilter: ['style', 'class'], subtree: true }));
    }
    // Watch for hud-active class changes on document root and tour overlay
    const hudObserver = new MutationObserver(() => {
      if (isGridActive()) {
        debouncedBuildGrid();
      } else {
        // Clear grid when HUD is inactive
        if (ctx) {
          const vw = window.innerWidth, vh = window.innerHeight;
          ctx.clearRect(0, 0, vw, vh);
        }
      }
    });
    // Also watch tour overlay for show/hide
    const tourOverlay = document.getElementById('tour-overlay');
    if (tourOverlay) {
      const tourObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const isHidden = tourOverlay.classList.contains('hidden');
            if (isHidden) {
              document.body.classList.remove('tour-active');
            } else {
              document.body.classList.add('tour-active');
              debouncedBuildGrid(); // rebuild grid when tour opens
            }
            // Trigger grid rebuild
            if (isGridActive()) {
              debouncedBuildGrid();
            } else {
              if (ctx) {
                const vw = window.innerWidth, vh = window.innerHeight;
                ctx.clearRect(0, 0, vw, vh);
              }
            }
          }
        });
      });
      tourObserver.observe(tourOverlay, { attributes: true, attributeFilter: ['class'] });
    }
    hudObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    
    // Resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        engine.resize(window.innerWidth, window.innerHeight);
      }, 250);
    });
    
    engine.resize(window.innerWidth, window.innerHeight);
    
  } catch (error) {
    console.error('[Bootstrap] ❌ Error:', error);
    // Do not replace body; keep app visible for diagnostics
  }
}

init();
</script>
<!-- Service Worker Registration -->
<script>
  // Service Worker registration with update notification
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // Use base path for Service Worker registration
      const swPath = (window.__UX4AI_BASE_PATH__ || '') + '/sw.js';
      console.log('[SW] Registering Service Worker at:', swPath);
      navigator.serviceWorker.register(swPath)
        .then((registration) => {
          console.log('[SW] Registered:', registration.scope);
          
          // Check for updates every 30 minutes
          setInterval(() => {
            registration.update();
          }, 30 * 60 * 1000);
          
          // Listen for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available - show notification, but don't auto-reload
                console.log('[SW] New version available');
                showUpdateNotification(newWorker);
              }
              // Removed auto-reload on activation to prevent reload loops
            });
          });
        })
        .catch((error) => {
          console.error('[SW] Registration failed:', error);
        });
      
      // Removed controllerchange listener to prevent reload loops
      // Users can manually reload if needed via update notification
    });
  }
  
  // Show update notification
  function showUpdateNotification(worker) {
    // Create notification banner
    const banner = document.createElement('div');
    banner.id = 'update-banner';
    banner.style.cssText = `
      position: fixed;
      top: 56px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      background: rgba(91, 156, 255, 0.95);
      color: #fff;
      padding: 12px 24px;
      border-radius: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 16px;
      font-family: ui-sans-serif, system-ui, sans-serif;
      font-size: 14px;
    `;
    
    banner.innerHTML = `
      <span>Доступна новая версия сайта</span>
      <button id="update-btn" style="
        padding: 6px 12px;
        background: var(--Color/Light/Surface/1);
        color: var(--Color/Accent/Primary);
        border: none;
        font-weight: 500;
        cursor: pointer;
      ">Обновить</button>
      <button id="dismiss-btn" style="
        padding: 6px 12px;
        background: transparent;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.5);
        font-weight: 500;
        cursor: pointer;
      ">Позже</button>
    `;
    
    document.body.appendChild(banner);
    
    // Update button
    document.getElementById('update-btn').addEventListener('click', () => {
      worker.postMessage({ type: 'SKIP_WAITING' });
      banner.remove();
    });
    
    // Dismiss button
    document.getElementById('dismiss-btn').addEventListener('click', () => {
      banner.remove();
    });
    
    // Analytics
    console.log('analytics: update_notification_shown');
  }
  
  // Force update function (accessible globally)
  window.forceUpdate = async function() {
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.getRegistration();
      if (registration) {
        registration.unregister();
        caches.keys().then((names) => {
          names.forEach(name => caches.delete(name));
        });
        window.location.reload(true);
      }
    }
  };
</script>
</body>
</html>

